<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Predictive checks | Just another Bayesian enthusiast</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Predictive checks" />
<meta name="author" content="Stippe" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In the previous post we saw some methods which allows us to spot problems in the trace evaluation. In this post we will look at some methods to check if our model is able to correctly reproduce the relevant features of the data. We will look at the “wing length” dataset, which is a quite well known dataset, representing the length of 100 houseflies, expressed in units of $10^{-1}$ mm." />
<meta property="og:description" content="In the previous post we saw some methods which allows us to spot problems in the trace evaluation. In this post we will look at some methods to check if our model is able to correctly reproduce the relevant features of the data. We will look at the “wing length” dataset, which is a quite well known dataset, representing the length of 100 houseflies, expressed in units of $10^{-1}$ mm." />
<link rel="canonical" href="http://localhost:4000/course/intro/predictive-checks/" />
<meta property="og:url" content="http://localhost:4000/course/intro/predictive-checks/" />
<meta property="og:site_name" content="Just another Bayesian enthusiast" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-24T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Predictive checks" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Stippe"},"dateModified":"2023-08-24T00:00:00+02:00","datePublished":"2023-08-24T00:00:00+02:00","description":"In the previous post we saw some methods which allows us to spot problems in the trace evaluation. In this post we will look at some methods to check if our model is able to correctly reproduce the relevant features of the data. We will look at the “wing length” dataset, which is a quite well known dataset, representing the length of 100 houseflies, expressed in units of $10^{-1}$ mm.","headline":"Predictive checks","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/course/intro/predictive-checks/"},"url":"http://localhost:4000/course/intro/predictive-checks/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Just another Bayesian enthusiast" />

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Just another Bayesian enthusiast</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About me</a><a class="page-link" href="/index">Home</a><a class="page-link" href="/links">Some useful resources</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Predictive checks</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-08-24T00:00:00+02:00" itemprop="datePublished">
        Aug 24, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In the previous post we saw some methods which allows
us to spot problems in the trace evaluation.
In this post we will look at some methods to check if our model is able to correctly
reproduce the relevant features of the data.
We will look at the “wing length” dataset, which is a quite well known dataset,
representing the length of 100 houseflies, expressed in units of $10^{-1}$ mm.</p>

<p>This dataset is well known, as it represents an excellent example of normally distributed
real world data.</p>

<p>Let us first of all load the libraries we will use and the dataset</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="n">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span> 
<span class="kn">from</span> <span class="n">pytensor.tensor.math</span> <span class="kn">import</span> <span class="n">gammaln</span>
<span class="kn">from</span> <span class="n">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="n">itables</span> <span class="kn">import</span> <span class="n">init_notebook_mode</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">default_rng</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">init_notebook_mode</span><span class="p">(</span><span class="n">all_interactive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">"</span><span class="s">seaborn-v0_8-darkgrid</span><span class="sh">"</span><span class="p">)</span>

<span class="n">df_length</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">https://seattlecentral.edu/qelp/sets/057/s057.txt</span><span class="sh">'</span><span class="p">,</span>
                        <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">).</span><span class="nf">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="sh">'</span><span class="s">wing_length</span><span class="sh">'</span><span class="p">})</span>
</code></pre></div></div>

<p>Before looking at the data, let us think about the problem we are trying do model.
What could be a typical length scale for the wing length of a housefly?
A housefly is as long as the nail of a kid, so somewhere between few millimeters
and a centimeter.
We can thus use our model, which spans all the range $0-100$ (remember we are working
in units of $10^{-1}$ mm)</p>

\[\begin{align}
&amp; y \sim Normal(\mu, \sigma) \\
&amp; \mu \sim Normal(0, 50) \\
&amp; \sigma \sim HalfCauchy(0, 50)
\end{align}\]

<p>Imagine a friend of yours tells you he is sure that a reasonable length scale
is around one millimeter with an uncertainty of the order of $0.1$ mm.
He will use the following model:</p>

\[\begin{align}
&amp; y \sim Normal(\mu, \sigma) \\
&amp; \mu \sim Normal(10, 1) \\
&amp; \sigma \sim Exponential(0.5)
\end{align}\]

<p>So you decide to bet, and the model which will be more accurate in describing the data
will win.</p>

<p>His model is implemented as</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_0</span><span class="p">:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Exponential</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">df_length</span> <span class="p">[</span><span class="sh">'</span><span class="s">wing_length</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p>He can now take a look at the prior predictive check</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_0</span><span class="p">:</span>
    <span class="n">prp0</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_prior_predictive</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">prp0</span><span class="p">.</span><span class="n">prior_predictive</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/prior_predictive_0.jpg" alt="Prior predictive friend" /></p>

<p>The prior predictive is good for him, but you think it is too restrictive, as you
are not sure about the informations you have, and you know he is not a
true expert in this field.
You can now implement your model:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_1</span><span class="p">:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfCauchy</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">df_length</span> <span class="p">[</span><span class="sh">'</span><span class="s">wing_length</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p>And you now check that your prior predictive spans the entire range $0-100$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_1</span><span class="p">:</span>
    <span class="n">prp1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_prior_predictive</span><span class="p">()</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="nf">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">hist</span><span class="p">(</span><span class="n">prp1</span><span class="p">.</span><span class="n">prior_predictive</span><span class="p">[</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="nf">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="nf">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/prior_predictive_1.jpg" alt="Prior predictive ours" /></p>

<p>The sample covers the entire range $[0-100]\,,$ so it looks good for you.
You can now both run your models</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_0</span><span class="p">:</span>
    <span class="n">tr0</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">()</span>

<span class="k">with</span> <span class="n">model_1</span><span class="p">:</span>
    <span class="n">tr1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">()</span>
</code></pre></div></div>

<p>And verify your traces</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">tr0</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/trace_housefly_pp_0.jpg" alt="Trace friend" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">tr1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/trace_housefly_pp_1.jpg" alt="Trace ours" /></p>

<p>Your trace looks fine, but your friend looks a little bit worried,
as $\sigma$ is very large with respect to what he expected.</p>

<p>You can finally verify which model does a better job in reproducing the data:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_0</span><span class="p">:</span>
    <span class="n">pp0</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_posterior_predictive</span><span class="p">(</span><span class="n">tr0</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="nf">plot_posterior_predictive</span><span class="p">(</span><span class="n">pp0</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/posterior_predictive_housefly_pp_0.jpg" alt="PP friend" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_1</span><span class="p">:</span>
    <span class="n">pp1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample_posterior_predictive</span><span class="p">(</span><span class="n">tr1</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="nf">plot_posterior_predictive</span><span class="p">(</span><span class="n">pp1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/predictive_checks/posterior_predictive_housefly_pp_1.jpg" alt="PP ours" /></p>

<p>While our mean estimate corresponds to the data within a good accuracy,
his sampled posterior predictive lies far away from the data.</p>

<h2 id="conclusions-and-take-home-message">Conclusions and take-home message</h2>
<ul>
  <li>Always perform the prior predictive check to ensure that the data, as you guess they are located, is not unlikely.</li>
  <li>You don’t have to exactly reproduce the data, as this would led you your model to overfit.</li>
  <li>If your problem is too complex for a simple prior predictive check, try and sample them and run your model with fake data.</li>
  <li>If you have no clue about the data distribution, you can perform your prior predictive with a small portion of the data (but you should then exclude those data from the analysis, as you should never use twice your data).</li>
  <li>Always make sure that your model is able to accurately reproduce the data with the posterior predictive check.</li>
  <li>In complex problem, the model will unlikely be able to <em>exactly</em> reproduce your data, but you should at least make sure that you can reproduce the <em>relevant features</em> of your data. You should also be sure and understand what your model fails to reproduce, and possibly why.</li>
</ul>

  </div><a class="u-url" href="/course/intro/predictive-checks/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Stippe</li>
          <li><a class="u-email" href="mailto:smaurizio87@protonmail.com">smaurizio87@protonmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/SteffPy" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://stackoverflow.com/users/11065831/stefano" target="_blank" title="stackoverflow">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/thestippe/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>

