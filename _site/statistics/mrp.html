<!DOCTYPE html>
<html lang="en"><head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W9G73E5P44"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W9G73E5P44');
</script>
          <link rel="icon" 
                type="image/png" 
                href="/docs/assets/images/dp_icon.png">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>MRP | Data Perspectives</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="MRP" />
<meta name="author" content="Data-perspectives" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The one who guessed US election results" />
<meta property="og:description" content="The one who guessed US election results" />
<link rel="canonical" href="http://localhost:4000/statistics/mrp" />
<meta property="og:url" content="http://localhost:4000/statistics/mrp" />
<meta property="og:site_name" content="Data Perspectives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-10-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="MRP" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Data-perspectives"},"dateModified":"2024-10-13T00:00:00+00:00","datePublished":"2024-10-13T00:00:00+00:00","description":"The one who guessed US election results","headline":"MRP","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/statistics/mrp"},"url":"http://localhost:4000/statistics/mrp"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Data Perspectives" />


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
<a rel="me" href="https://vis.social/@thestippe" style="display: none;">Mastodon</a>
<link rel="manifest" href="manifest.json">
</head>
<body>

        <div id='upperBar'><header class="site-header">

        <div id='upperBarr'>
        <script src="https://d3js.org/d3.v7.js"></script>
                <div class="wrapper" style="display:flex;">

                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                    
                    
                    

        <ul hidden='hidden' id="postList"><li>
                        Poisson regression;/statistics/poisson_regression;1
                </li><li>
                        Logistic regression;/statistics/logistic_regression;2
                </li><li>
                        Robust linear regression;/statistics/robust_regression;3
                </li><li>
                        Multi-linear regression;/statistics/multivariate_regression;4
                </li><li>
                        Linear regression with binary input;/statistics/regression_binary_input;5
                </li><li>
                        Horseshoe priors;/statistics/horseshoe;6
                </li><li>
                        Introduction to the linear regression;/statistics/regression;7
                </li><li>
                        MRP;/statistics/mrp;8
                </li><li>
                        Model comparison, cont.;/statistics/model_averaging_cont;9
                </li><li>
                        Model comparison;/statistics/model_averaging;10
                </li><li>
                        Application of the Lotka-Volterra model;/statistics/lotka_volterra;11
                </li><li>
                        Differential equations;/statistics/ode;12
                </li><li>
                        Introduction to GIS;/gis/gis_intro;13
                </li><li>
                        Re-parametrizing your model;/statistics/reparametrization;14
                </li><li>
                        Predictive checks;/statistics/predictive_checks;15
                </li><li>
                        Trace inspection;/statistics/trace_inspection;16
                </li><li>
                        Introduction to the Bayesian workflow;/statistics/bayesian_workflow;17
                </li><li>
                        Mixture models;/statistics/mixture;18
                </li><li>
                        Multidimensional distributions;/statistics/categories;19
                </li><li>
                        Dirichlet Process Mixture Models;/statistics/dp;20
                </li><li>
                        The Gaussian model;/statistics/reals;21
                </li><li>
                        Bayesian Additive Regression Trees;/statistics/bart;22
                </li><li>
                        Bonus: counting animals in a park;/statistics/hypergeom;23
                </li><li>
                        Splines;/statistics/spline;24
                </li><li>
                        The Negative Binomial model;/statistics/negbin;25
                </li><li>
                        Gaussian processes regression;/statistics/gp_example;26
                </li><li>
                        Gaussian processes;/statistics/gp;27
                </li><li>
                        The Poisson model;/statistics/poisson;28
                </li><li>
                        Nonparametric models;/statistics/nonparametric_intro;29
                </li><li>
                        The Beta-Binomial model;/statistics/betabin;30
                </li><li>
                        Structural time series;/statistics/structural_time_series;31
                </li><li>
                        Time series;/statistics/time_series;32
                </li><li>
                        Some notation about probability;/statistics/probability_reminder;33
                </li><li>
                        Synthetic control;/statistics/synthetic_control;34
                </li><li>
                        How does MCMC works;/statistics/mcmc_intro;35
                </li><li>
                        Regression discontinuity design;/statistics/rdd;36
                </li><li>
                        Introduction to Bayesian inference;/statistics/bayes_intro;37
                </li><li>
                        An overview to statistics;/statistics/preface;38
                </li><li>
                        Difference in difference;/statistics/difference_in_differences;39
                </li><li>
                        Instrumental variable regression;/statistics/instrumental_variable;40
                </li><li>
                        Randomized controlled trials;/statistics/randomized;41
                </li><li>
                        Causal inference and Bayesian networks;/statistics/causal_intro_2;42
                </li><li>
                        Causal inference;/statistics/causal_intro;43
                </li><li>
                        Experiment analysis with many blocking variables;/statistics/experiment_design_cont;44
                </li><li>
                        Experiment analysis;/statistics/experiment_design;45
                </li><li>
                        Introduction to Extreme Values theory;/statistics/extreme_intro;46
                </li><li>
                        Application of survival analysis with discrete times;/statistics/survival_example_2;47
                </li><li>
                        Application of survival analysis 1;/statistics/survival_example;48
                </li><li>
                        Introduction to survival analysis;/statistics/survival_analysis;49
                </li><li>
                        Random models and mixed models;/statistics/random_models;50
                </li><li>
                        Hierarchical models and meta-analysis;/statistics/hierarchical_metaanalysis;51
                </li><li>
                        Hierarchical models;/statistics/hierarchical_models;52
                </li><li>
                        Drawing geographic maps;/dataviz/geography;53
                </li><li>
                        The Gestalt principles;/dataviz/gestalt;54
                </li><li>
                        Design tricks;/dataviz/design-introduction;55
                </li><li>
                        How to choose a color map;/dataviz/palettes-introduction;56
                </li><li>
                        Introduction to color perception;/dataviz/color-introduction;57
                </li><li>
                        Drawing is redrawing;/dataviz/gender-economist;58
                </li><li>
                        Visual queries;/dataviz/visual-queries;59
                </li><li>
                        Channel effectiveness;/dataviz/effectiveness;60
                </li><li>
                        Evolutions of the line chart;/dataviz/linechart-evolution;61
                </li><li>
                        Beyond the 1D scatterplot;/dataviz/scatterplot-evolution;62
                </li><li>
                        Perception;/dataviz/perception;63
                </li><li>
                        Fundamental charts;/dataviz/fundamental-charts;64
                </li><li>
                        Marks and channels;/dataviz/marks-channels;65
                </li><li>
                        Data abstraction;/dataviz/data-types;66
                </li><li>
                        Data visualization;/dataviz/dataviz;67
                </li><li>
                        Section introduction;/statistics/simple_models_intro;68
                </li></ul>
                        <div style="display:flex">
                  <a href="/statistics/model_averaging_cont" class="prev">&#8249;</a>
                  
                                <a href="/"><img class="site-masthead" src="/docs/assets/images/logo_dp.png" alt="Data Perspectives" id="logo" /></a><div id='searchNav' style="flex;">
                                        <input type="search" id="search_0" class="searchBar" onkeydown="searchText()" placeholder="Search">
                                </div>

                                <div hidden='hidden' id="search_focus">0</div>



                        </div><nav class="site-nav" style="display:flex;">
                                <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                                <label for="nav-trigger">
                                        <span class="menu-icon">
                                                <svg viewBox="0 0 18 15" width="18px" height="15px">
                                                        <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
                                                </svg>
                                        </span>
                                </label>

                                <div class="trigger"><a  class="page-link" href="/about">About me</a><a  class="page-link" href="/links">Resources</a>
                                <a href="/statistics/" class="page-link">Up</a>
                                
                                </div>
                        </nav>
                  <a href="/statistics/regression" class="next">&#8250;</a>
                  
        </div>


        <script src="/docs/assets/javascript/search.js">
        </script>
                </div>

</header>
<div class="progress-container">
    <div class="progress-bar" id="myBar"></div>
    </div>
        </div>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
          <div id='topPage'></div>
        <a href='/index'>
<img src="/docs/assets/images/background_resized.webp" alt="backround" style="margin:auto;display:block;width:1200px">

</a>
    <h1 class="post-title p-name" itemprop="name headline">MRP</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-10-13T00:00:00+00:00" itemprop="datePublished">
        Oct 13, 2024
      </time></p>
    <p class="post-meta"> Reading time: <span class="reading-time" title="Estimated read time">
  
  29&prime;
</span>
</p>
  </header>
  <br>

  <div class="post-content e-content" itemprop="articleBody">
    <p>MRP stands for <strong>Multilevel Regression and Post-stratification</strong>, and is a very
popular way to make inference based on surveys, especially with the ones
with selected samples.</p>

<p>The main issue with sampling is how to deal with non-responders,
and MrP allows you to correct for this issue if it is properly done.
You can consider MrP as a two-stage procedure:</p>

<ol>
  <li>Perform a multilevel regression on your sample</li>
  <li>re-weight the probabilities of each of your subpopulations with weights extracted from a census to obtain the population probability.</li>
</ol>

<p>Using multilevel regression allows you to share information across subpopulations, so the variance distribution will have a smoother behavior across them with respect to a single-level model.
Post-stratification is instead needed because, even if your sample is a random sample of your population,
non-respondence might be no random at all, and this could introduce a sampling bias into the respondent sample.
You should however always be very careful with surveys. In fact, 
as J. Ornstein reminds us in <a href="https://link.springer.com/chapter/10.1007/978-3-031-12982-7_5">Causality in Policy Studies</a>:</p>

<p><br /></p>

<blockquote>
  <p>MRP is not a panacea, and one should be skeptical of estimates produced from small-sample surveys, 
regardless of how they are operationalized.</p>

  <p>Joseph T. Ornstein</p>
</blockquote>

<p><br /></p>

<p>In the following we will use MRP to analyze the data collected in 
<a href="https://www.sciencedirect.com/science/article/pii/S2352340919304986#bib10">this study on conspiracy believes of the Italian population</a>,
and the dataset can be downloaded from
<a href="https://ars.els-cdn.com/content/image/1-s2.0-S2352340919304986-mmc1.zip">this link</a>.
We will adapt the MRP model as shown in
<a href="https://bookdown.org/jl5522/MRP-case-studies/">“MRP case studies” by Juan Lopez-Martin, Justin H. Phillips, and Andrew Gelman</a>.</p>

<h2 id="data-import-and-initial-transformations">Data import and initial transformations</h2>

<p>In this first part we will re-organize the data prepare the datasets
for the fit.
This part is quite technical, 
and I decided to keep it because it might be useful
to see that the data preparation can be a rather cumbersome procedure,
but the uninterested reader can safely skip it.
The population dataset has been obtained from the
<a href="https://esploradati.istat.it/databrowser/#/it/dw/categories/IT1,Z0820EDU,1.0/DCCV_POPTIT1_UNT2020/IT1,52_1194_DF_DCCV_POPTIT1_UNT2020_1,1.0">ISTAT -the official italian statistics institute- webpage</a>.</p>

<p>We used this dataset because, as it is well known, education is a very relevant factor in
conspiracy beliefs, so we used the dataset where the italian population
is given by age, sex, geographic area and education level.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">df_anag</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/istruzione.csv'</span><span class="p">)</span>

<span class="n">df_anag</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: right">Anno</th>
      <th style="text-align: left">Regione</th>
      <th style="text-align: left">Sesso</th>
      <th style="text-align: left">Fascia</th>
      <th style="text-align: right">Elementare</th>
      <th style="text-align: right">Media</th>
      <th style="text-align: right">Professionale</th>
      <th style="text-align: right">Maturita</th>
      <th style="text-align: right">Laurea</th>
      <th style="text-align: right">Totale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">15-24 anni</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">667</td>
      <td style="text-align: right">90</td>
      <td style="text-align: right">518</td>
      <td style="text-align: right">63</td>
      <td style="text-align: right">1350</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">25-29 anni</td>
      <td style="text-align: right">6</td>
      <td style="text-align: right">121</td>
      <td style="text-align: right">80</td>
      <td style="text-align: right">300</td>
      <td style="text-align: right">190</td>
      <td style="text-align: right">698</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">30-34 anni</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">184</td>
      <td style="text-align: right">84</td>
      <td style="text-align: right">271</td>
      <td style="text-align: right">189</td>
      <td style="text-align: right">737</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">35-39 anni</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">227</td>
      <td style="text-align: right">92</td>
      <td style="text-align: right">282</td>
      <td style="text-align: right">201</td>
      <td style="text-align: right">811</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">40-44 anni</td>
      <td style="text-align: right">20</td>
      <td style="text-align: right">298</td>
      <td style="text-align: right">108</td>
      <td style="text-align: right">356</td>
      <td style="text-align: right">184</td>
      <td style="text-align: right">965</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_spss</span><span class="p">(</span><span class="s">'./data/dib_104144_dataset.sav'</span><span class="p">)</span>

<span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s">'region'</span><span class="p">,</span> <span class="s">'sex'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'edu'</span><span class="p">,</span> <span class="s">'cb11'</span><span class="p">]]</span>

<span class="n">df_data</span><span class="p">[</span><span class="s">'y0'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="s">'cb11'</span><span class="p">].</span><span class="n">replace</span><span class="p">({</span><span class="s">'Completely disagree'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'Completely agree'</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>

<span class="n">df_data</span><span class="p">.</span><span class="n">to_markdown</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: left">region</th>
      <th style="text-align: left">sex</th>
      <th style="text-align: right">age</th>
      <th style="text-align: left">edu</th>
      <th style="text-align: left">cb11</th>
      <th style="text-align: right">y0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">37</td>
      <td style="text-align: left">degree</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">20</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">19</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">19</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">North</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">31</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<p>The target variable is the answer to the question
“Vaccines are useless and dangerous, they are only instrumental to the financial interests of pharmaceutical
companies”
from <a href="https://www.sciencedirect.com/science/article/abs/pii/S0191886918303751">Avoidant attachment style and conspiracy ideation</a>
and the answer goes from 1 (completely disagree) to 5 (completely agree).
We will transform it and make it binary, and the transformed variable will be 1
if the respondent answered 4 or 5 to the above question.
As regressors, we will use as starting point:</p>
<ul>
  <li>the region, marked N for North, C for center and M for south or islands.</li>
  <li>the sex (M/F)</li>
  <li>the age (integer)</li>
  <li>the education level</li>
</ul>

<p>Let us look to the education</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'edu'</span><span class="p">).</span><span class="n">count</span><span class="p">()[</span><span class="s">'region'</span><span class="p">]</span>
</code></pre></div></div>

<div class="code">
edu
<br />
0.0                    6
<br />
degree               306
<br />
high school          350
<br />
no qualifications      2
<br />
post graduate         73
<br />
primary school         3
<br />
secondary school      34
<br />
Name: region, dtype: int64
<br />
</div>

<p>Since in Italy the vast majority of the adult population has at least a high school degree,
we will only use the university degree as regressor, otherwise we wouldn’t
have a sufficient number of subject in order to get a reliable estimate of the regression
coefficients.</p>

<p>Let us now stratify the age, since it doesn’t make much sense to the bare age as regressor.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_a0</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'15-24 anni'</span><span class="p">,</span> <span class="s">'25-29 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a1</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'30-34 anni'</span><span class="p">,</span> <span class="s">'35-39 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a2</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'40-44 anni'</span><span class="p">,</span> <span class="s">'45-49 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a3</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'50-54 anni'</span><span class="p">,</span> <span class="s">'55-59 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a4</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'60-64 anni'</span><span class="p">,</span> <span class="s">'65 anni e più'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">df_a0</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df_a1</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">df_a2</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">df_a3</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">df_a4</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">df_anag_new</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_a0</span><span class="p">,</span> <span class="n">df_a1</span><span class="p">,</span> <span class="n">df_a2</span><span class="p">,</span> <span class="n">df_a3</span><span class="p">,</span> <span class="n">df_a4</span><span class="p">])</span>
</code></pre></div></div>

<p>We can now transform the sample dataframe</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_fit</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s">'region'</span><span class="p">,</span> <span class="s">'sex'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'edu'</span><span class="p">,</span> <span class="s">'y0'</span><span class="p">]]</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'region'</span><span class="p">]</span><span class="o">==</span><span class="s">'Center'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'region'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'South'</span><span class="p">,</span> <span class="s">'Islands'</span><span class="p">])).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'sex'</span><span class="p">]</span><span class="o">==</span><span class="s">'Male'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="s">'edu'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'degree'</span><span class="p">,</span> <span class="s">'post graduate'</span><span class="p">]).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'age'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># if the age is not reported "age" has value -99
</span>
<span class="k">def</span> <span class="nf">map_age</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">40</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>

<span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="s">'age'</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="n">map_age</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_fit</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'y0'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="explorative-analysis">Explorative analysis</h2>

<p>We can now look for differences between the survey sample and the italian population.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_anag_new</span><span class="p">[</span><span class="s">'NoLaurea'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anag_new</span><span class="p">[</span><span class="s">'Totale'</span><span class="p">]</span><span class="o">-</span><span class="n">df_anag_new</span><span class="p">[</span><span class="s">'Laurea'</span><span class="p">]</span>
<span class="n">df_anag_deg</span> <span class="o">=</span> <span class="n">df_anag_new</span><span class="p">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'NoLaurea'</span><span class="p">],</span>
                               <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">],</span>
                               <span class="n">value_name</span><span class="o">=</span><span class="s">'number'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">==</span><span class="s">'Laurea'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'frac'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'number'</span><span class="p">]</span><span class="o">/</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'number'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span>

<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="s">'C'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="s">'M'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Sesso'</span><span class="p">]</span><span class="o">==</span><span class="s">'M'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_means_by_group</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">]).</span><span class="n">mean</span><span class="p">().</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_n_by_group</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">]).</span><span class="n">count</span><span class="p">().</span><span class="n">reset_index</span><span class="p">()</span>
</code></pre></div></div>

<p>We prepared two auxiliary datasets, and the last one counts
how many units for each stratum are present in the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
</code></pre></div></div>
<div class="code">
0
</div>

<p>There is at least one unit for each stratum, and this is a first indicator
that our age groups are large enough.
Let us compare the population percentages for each regression variable
with the corresponding sample percentage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="s">'C'</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s">'M'</span><span class="p">,</span> <span class="s">'N'</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Gruppo'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Gruppo'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Population'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Sample'</span><span class="p">)</span>

<span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span>
<span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Regione'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Regione'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'Regione'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Regione'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'is_male'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'is_male'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>


<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/percentages.webp" alt="" /></p>

<p>There are very large differences between the sample and the population,
and this might lead to an unreliable estimate for our target variable.</p>

<h2 id="fitting-the-model">Fitting the model</h2>

<p>We will use a hierarchical model with the previously mentioned regressors,
and the implemented model is the following one:</p>

\[\begin{align*}
logit P(y^i=1) = &amp;  \theta^i \\
\\
\theta^i = &amp; \alpha + \gamma_{C} X^i_{Centro}+ \gamma_{M} X^i_{Mezzogiorno} \\
&amp; + \beta_{Male} X^i_{Male} + \beta_{Group}^{g[i]}+ \beta_{Degree}^{g[i]} X^{i}_{Degree} \\
&amp; + \beta_{Male, Edu}^{g[i]}X^i_{Male} X^{i}_{Degree}
\end{align*}\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sigma_group</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_group'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_degree'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sigma_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_male_edu'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">alpha_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha_degree'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">alpha_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha_male_edu'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">beta_group_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_group_std'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_group</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_group'</span><span class="p">,</span> <span class="n">sigma_group</span><span class="o">*</span><span class="n">beta_group_std</span><span class="p">)</span>
    <span class="n">beta_male</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_male'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">beta_male_edu_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_male_edu_std'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_degree_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_degree_std'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_degree'</span><span class="p">,</span> <span class="n">alpha_degree</span><span class="o">+</span><span class="n">beta_degree_std</span><span class="o">*</span><span class="n">sigma_degree</span><span class="p">)</span>
    <span class="n">beta_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_male_edu'</span><span class="p">,</span> <span class="n">alpha_male_edu</span><span class="o">+</span><span class="n">beta_male_edu_std</span><span class="o">*</span><span class="n">sigma_male_edu</span><span class="p">)</span>
    <span class="n">gamma_centro</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'gamma_centro'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gamma_mezzogiorno</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'gamma_mezzogiorno'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_group</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span> <span class="o">+</span> <span class="n">beta_male</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_degree</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma_centro</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span><span class="o">+</span> <span class="n">gamma_mezzogiorno</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span>
         <span class="o">+</span> <span class="n">beta_male_edu</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">logit_p</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'y'</span><span class="p">])</span>

<span class="n">pm</span><span class="p">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/model.webp" alt="" /></p>

<p>As you can see, we slightly modified our parametrization to improve the convergence.
We are now ready to sample the posterior.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">idata</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nuts_sampler</span><span class="o">=</span><span class="s">'numpyro'</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                      <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/trace.webp" alt="" /></p>

<p>The traces look fine, but since this is quite a messy model, it is better to also inspect
the $\hat{R}$ statistics</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">summary</span><span class="p">(</span><span class="n">idata</span><span class="p">)[</span><span class="s">'r_hat'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
</code></pre></div></div>

<div class="code">
1.0
</div>

<p>$\hat{R}$ is fine too, so we can assume that there are no issues with our model.
Let us take a look at the separation plot</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">idata</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">))</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_separation</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/separation.webp" alt="" /></p>

<p>The result is far from being perfect, but the darker blue lines are mostly
on the right hand side, so the model is doing quite a decent job.
We can now verify the results of our model.
Let us implement two routines to perform the model predictions,
with and without post-stratification:</p>

\[\begin{align*}
\theta_{PS} = &amp; \frac{\sum_i N_i \theta_i}{\sum_i N_i} \\
\theta_{Raw} = &amp; \frac{\sum_i  N_i^{sample} \theta_i}{\sum_i N_i^{sample}}
\end{align*}\]

<p>where $N_i$ is the number of individuals in the group i (or equivalently the percentage),
and $\theta_i$ the corresponding estimate.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fcalc</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">idata</span><span class="p">.</span><span class="n">posterior</span>
    <span class="n">logit_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s">'alpha'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_group'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_group_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_male'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_degree'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_degree_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_male_edu'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_male_edu_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'gamma_mezzogiorno'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'gamma_centro'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span>
              <span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logit_p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_proba</span><span class="p">(</span><span class="n">df_filt</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'frac'</span><span class="p">):</span>
    <span class="n">out_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_ql</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_qh</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">df_filt</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_filt</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">dt</span> <span class="o">+=</span> <span class="n">fcalc</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span>
    <span class="n">out_mean</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">out_ql</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">out_qh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">out_mean</span><span class="p">,</span> <span class="n">out_ql</span><span class="p">,</span> <span class="n">out_qh</span><span class="p">]</span>
</code></pre></div></div>

<p>We can now compare the results of the post-stratification with the corresponding
raw estimate</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nat_proba</span> <span class="o">=</span> <span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">)</span>

<span class="n">grp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">'N'</span><span class="p">,</span> <span class="s">'C'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">]):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
    
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[((</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">)</span> <span class="p">)])</span>
           <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
    <span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'PS'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>

    <span class="n">prob1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[((</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">))],</span> <span class="n">col</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
    <span class="n">asymmetric_error1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'Raw'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Region=</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'&lt;30'</span><span class="p">,</span> <span class="s">'30-39'</span><span class="p">,</span> <span class="s">'40-49'</span><span class="p">,</span> <span class="s">'50-59'</span><span class="p">,</span> <span class="s">'60+'</span><span class="p">])</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

</code></pre></div></div>
<p><img src="/docs/assets/images/statistics/mrp/PS_compare.webp" alt="" /></p>

<p>We recall that the percentages of people with a degree in our sample is very different
from the one in the Italian population, and this implies that there are
large differences between the post-stratified estimates and the raw estimates.</p>

<p>We can now inspect the effect of the education for each region and age group.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">'N'</span><span class="p">,</span> <span class="s">'C'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
        
        <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[((</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">==</span><span class="n">deg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp</span><span class="p">))])</span>
               <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
        <span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">deg</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">deg</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'Has degree=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>


    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Region=</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'&lt;30'</span><span class="p">,</span> <span class="s">'30-39'</span><span class="p">,</span> <span class="s">'40-49'</span><span class="p">,</span> <span class="s">'50-59'</span><span class="p">,</span> <span class="s">'60+'</span><span class="p">])</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/estimates.webp" alt="" /></p>

<p>We can finally provide a national-level estimate for the target probability</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nat_proba_raw</span> <span class="o">=</span> <span class="n">get_proba</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>

<span class="n">dt_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">dt_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">dt_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

<span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_low</span><span class="p">),</span>
                                     <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_high</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)))).</span><span class="n">T</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)),</span> <span class="n">dt_mean</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'Post-stratified'</span><span class="p">,</span> <span class="s">'Raw estimate'</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/national_estimate.webp" alt="" /></p>

<p>The mean difference between the stratified estimate and the raw one
is of the order of the 10%,
and it’s of the same order of magnitude of the 90% CI,
therefore the raw estimate is totally unreliable.</p>

<h2 id="conclusions">Conclusions</h2>

<p>We discussed MRP, and we have seen how to implement it in Python in order to provide
reliable estimates for surveys, especially when they are performed on a selected population.</p>

<h2 id="suggested-readings">Suggested readings</h2>

<ul>
  <li><a href="https://bookdown.org/jl5522/MRP-case-studies/">“MRP case studies” and references therein, by Juan Lopez-Martin, Justin H. Phillips, and Andrew Gelman</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">watermark</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">p</span> <span class="n">xarray</span><span class="p">,</span><span class="n">numpyro</span><span class="p">,</span><span class="n">jax</span><span class="p">,</span><span class="n">jaxlib</span>
</code></pre></div></div>
<div class="code">
Last updated: Wed Aug 28 2024
<br />

<br />
Python implementation: CPython
<br />
Python version       : 3.12.4
<br />
IPython version      : 8.24.0
<br />

<br />
xarray : 2024.5.0
<br />
numpyro: 0.15.0
<br />
jax    : 0.4.28
<br />
jaxlib : 0.4.28
<br />

<br />
numpy     : 1.26.4
<br />
pymc      : 5.16.2
<br />
pandas    : 2.2.2
<br />
seaborn   : 0.13.2
<br />
matplotlib: 3.9.0
<br />
arviz     : 0.18.0
<br />

<br />
Watermark: 2.4.3
<br />
</div>

  </div><a class="u-url" href="/statistics/mrp" hidden></a>

  <br>
  <div id='autograph'>
          Stippe Oct 13, 2024

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>


  <div class="wrapper">
          <div class='footer-text'>
                  Opinions are mine, mistakes too, and if you find any feel free to report it via mail or via Twitter.
                  <br>
                  Most of the material in the statistics section is an adaptation to Python of some pre-existing model.
                  <br>
                  I have tried to provide the necessary credits, but if you think that a relevant contribution is missing, please let me know.
                  <br>
                  No AI were harmed in creating this blog.
                  <br>
                  This is a blog, not a bakery: there are no cookies here!
                  <br>
                  The top image has been generated with a modified version Dan Gries' code, available at <a href="http://rectangleworld.com/blog/archives/538">http://rectangleworld.com</a>.
          </div>
          <br>

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Data-perspectives</li>
          <li><a class="u-email" href="mailto:dataperspectivesblog@gmail.com">dataperspectivesblog@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/SteffPy" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://stackoverflow.com/users/11065831/stefano" target="_blank" title="stackoverflow">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/thestippe/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://vis.social/@thestippe" target="_blank" title="mastodon">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#mastodon"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

  <script src="/docs/assets/javascript/scroll.js">
  </script>

</html>

