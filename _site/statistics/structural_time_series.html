<!DOCTYPE html>
<html lang="en"><head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W9G73E5P44"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W9G73E5P44');
</script>
          <link rel="icon" 
                type="image/png" 
                href="/docs/assets/images/dp_icon.png">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Structural time series | Data Perspectives</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Structural time series" />
<meta name="author" content="Data-perspectives" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Adding other kinds of temporal dependencies" />
<meta property="og:description" content="Adding other kinds of temporal dependencies" />
<link rel="canonical" href="http://localhost:4000/statistics/structural_time_series" />
<meta property="og:url" content="http://localhost:4000/statistics/structural_time_series" />
<meta property="og:site_name" content="Data Perspectives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-07-22T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Structural time series" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Data-perspectives"},"dateModified":"2024-07-22T00:00:00+00:00","datePublished":"2024-07-22T00:00:00+00:00","description":"Adding other kinds of temporal dependencies","headline":"Structural time series","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/statistics/structural_time_series"},"url":"http://localhost:4000/statistics/structural_time_series"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Data Perspectives" />


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
<a rel="me" href="https://vis.social/@thestippe" style="display: none;">Mastodon</a>
<link rel="manifest" href="manifest.json">
</head>
<body>

        <div id='upperBar'><header class="site-header">

        <div id='upperBarr'>
        <script src="https://d3js.org/d3.v7.js"></script>
                <div class="wrapper" style="display:flex;">

                
                
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                
                  
                    
                    
                    
                    
                    

        <ul hidden='hidden' id="postList"><li>
                        Poisson regression;/statistics/poisson_regression;1
                </li><li>
                        Logistic regression;/statistics/logistic_regression;2
                </li><li>
                        Robust linear regression;/statistics/robust_regression;3
                </li><li>
                        Multi-linear regression;/statistics/multivariate_regression;4
                </li><li>
                        Linear regression with binary input;/statistics/regression_binary_input;5
                </li><li>
                        Horseshoe priors;/statistics/horseshoe;6
                </li><li>
                        Introduction to the linear regression;/statistics/regression;7
                </li><li>
                        MRP;/statistics/mrp;8
                </li><li>
                        Model comparison, cont.;/statistics/model_averaging_cont;9
                </li><li>
                        Model comparison;/statistics/model_averaging;10
                </li><li>
                        Application of the Lotka-Volterra model;/statistics/lotka_volterra;11
                </li><li>
                        Differential equations;/statistics/ode;12
                </li><li>
                        Introduction to GIS;/gis/gis_intro;13
                </li><li>
                        Re-parametrizing your model;/statistics/reparametrization;14
                </li><li>
                        Predictive checks;/statistics/predictive_checks;15
                </li><li>
                        Trace inspection;/statistics/trace_inspection;16
                </li><li>
                        Introduction to the Bayesian workflow;/statistics/bayesian_workflow;17
                </li><li>
                        Mixture models;/statistics/mixture;18
                </li><li>
                        Multidimensional distributions;/statistics/categories;19
                </li><li>
                        Dirichlet Process Mixture Models;/statistics/dp;20
                </li><li>
                        The Gaussian model;/statistics/reals;21
                </li><li>
                        Bayesian Additive Regression Trees;/statistics/bart;22
                </li><li>
                        Bonus: counting animals in a park;/statistics/hypergeom;23
                </li><li>
                        Splines;/statistics/spline;24
                </li><li>
                        The Negative Binomial model;/statistics/negbin;25
                </li><li>
                        Gaussian processes regression;/statistics/gp_example;26
                </li><li>
                        Gaussian processes;/statistics/gp;27
                </li><li>
                        The Poisson model;/statistics/poisson;28
                </li><li>
                        Nonparametric models;/statistics/nonparametric_intro;29
                </li><li>
                        The Beta-Binomial model;/statistics/betabin;30
                </li><li>
                        Structural time series;/statistics/structural_time_series;31
                </li><li>
                        Time series;/statistics/time_series;32
                </li><li>
                        Some notation about probability;/statistics/probability_reminder;33
                </li><li>
                        Synthetic control;/statistics/synthetic_control;34
                </li><li>
                        How does MCMC works;/statistics/mcmc_intro;35
                </li><li>
                        Regression discontinuity design;/statistics/rdd;36
                </li><li>
                        Introduction to Bayesian inference;/statistics/bayes_intro;37
                </li><li>
                        An overview to statistics;/statistics/preface;38
                </li><li>
                        Difference in difference;/statistics/difference_in_differences;39
                </li><li>
                        Instrumental variable regression;/statistics/instrumental_variable;40
                </li><li>
                        Randomized controlled trials;/statistics/randomized;41
                </li><li>
                        Causal inference and Bayesian networks;/statistics/causal_intro_2;42
                </li><li>
                        Causal inference;/statistics/causal_intro;43
                </li><li>
                        Experiment analysis with many blocking variables;/statistics/experiment_design_cont;44
                </li><li>
                        Experiment analysis;/statistics/experiment_design;45
                </li><li>
                        Introduction to Extreme Values theory;/statistics/extreme_intro;46
                </li><li>
                        Application of survival analysis with discrete times;/statistics/survival_example_2;47
                </li><li>
                        Application of survival analysis 1;/statistics/survival_example;48
                </li><li>
                        Introduction to survival analysis;/statistics/survival_analysis;49
                </li><li>
                        Random models and mixed models;/statistics/random_models;50
                </li><li>
                        Hierarchical models and meta-analysis;/statistics/hierarchical_metaanalysis;51
                </li><li>
                        Hierarchical models;/statistics/hierarchical_models;52
                </li><li>
                        Drawing geographic maps;/dataviz/geography;53
                </li><li>
                        The Gestalt principles;/dataviz/gestalt;54
                </li><li>
                        Design tricks;/dataviz/design-introduction;55
                </li><li>
                        How to choose a color map;/dataviz/palettes-introduction;56
                </li><li>
                        Introduction to color perception;/dataviz/color-introduction;57
                </li><li>
                        Drawing is redrawing;/dataviz/gender-economist;58
                </li><li>
                        Visual queries;/dataviz/visual-queries;59
                </li><li>
                        Channel effectiveness;/dataviz/effectiveness;60
                </li><li>
                        Evolutions of the line chart;/dataviz/linechart-evolution;61
                </li><li>
                        Beyond the 1D scatterplot;/dataviz/scatterplot-evolution;62
                </li><li>
                        Perception;/dataviz/perception;63
                </li><li>
                        Fundamental charts;/dataviz/fundamental-charts;64
                </li><li>
                        Marks and channels;/dataviz/marks-channels;65
                </li><li>
                        Data abstraction;/dataviz/data-types;66
                </li><li>
                        Data visualization;/dataviz/dataviz;67
                </li><li>
                        Section introduction;/statistics/simple_models_intro;68
                </li></ul>
                        <div style="display:flex">
                  <a href="/statistics/time_series" class="prev">&#8249;</a>
                  
                                <a href="/"><img class="site-masthead" src="/docs/assets/images/logo_dp.png" alt="Data Perspectives" id="logo" /></a><div id='searchNav' style="flex;">
                                        <input type="search" id="search_0" class="searchBar" onkeydown="searchText()" placeholder="Search">
                                </div>

                                <div hidden='hidden' id="search_focus">0</div>



                        </div><nav class="site-nav" style="display:flex;">
                                <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                                <label for="nav-trigger">
                                        <span class="menu-icon">
                                                <svg viewBox="0 0 18 15" width="18px" height="15px">
                                                        <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
                                                </svg>
                                        </span>
                                </label>

                                <div class="trigger"><a  class="page-link" href="/about">About me</a><a  class="page-link" href="/links">Resources</a>
                                <a href="/statistics/" class="page-link">Up</a>
                                
                                </div>
                        </nav>
                  <a href="/statistics/betabin" class="next">&#8250;</a>
                  
        </div>


        <script src="/docs/assets/javascript/search.js">
        </script>
                </div>

</header>
<div class="progress-container">
    <div class="progress-bar" id="myBar"></div>
    </div>
        </div>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
          <div id='topPage'></div>
        <a href='/index'>
<img src="/docs/assets/images/background_resized.webp" alt="backround" style="margin:auto;display:block;width:1200px">

</a>
    <h1 class="post-title p-name" itemprop="name headline">Structural time series</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-07-22T00:00:00+00:00" itemprop="datePublished">
        Jul 22, 2024
      </time></p>
    <p class="post-meta"> Reading time: <span class="reading-time" title="Estimated read time">
  
  10&prime;
</span>
</p>
  </header>
  <br>

  <div class="post-content e-content" itemprop="articleBody">
    <p>In the <a href="/statistics/time_series">last post</a>
we allowed for autocorrelation across measures. In this post we will
adapt our model to include other forms of temporal dependencies.
We will use the dataset used by Harvey and Durbin
in the well known <a href="https://www.jstor.org/stable/2981553">1986 study on the british seat belt legislation</a>.
The raw data can be found in <a href="https://github.com/SurajGupta/r-source/blob/master/src/library/datasets/data/Seatbelts.R">this repo</a>.</p>

<p>The study analyzes the impact of the 1983 seat belt legislation which made
seat belts mandatory on the monthly number of deceased or seriously injured
car drivers.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">pytensor</span> <span class="k">as</span> <span class="n">pt</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'https://raw.githubusercontent.com/thestippe/thestippe.github.io/main/data/seatbelt_uk_harvey.csv'</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s">'Date'</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Date'</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'Date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'drivers'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'law'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s">'Date'</span><span class="p">].</span><span class="nb">min</span><span class="p">(),</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/structural_ts/drivers.webp" alt="" /></p>

<p>The data shows a strong periodic (yearly) component, and this seems quite reasonable,
due to bad road conditions in winter caused by ice and other climate-related factors.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df</span><span class="p">[</span><span class="s">'month'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'Date'</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">month</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'month'</span><span class="p">).</span><span class="n">mean</span><span class="p">()[</span><span class="s">'drivers'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="s">'drivers'</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s">'month'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/structural_ts/drivers_by_month.webp" alt="" /></p>

<p>We can add a periodic component by expanding it into its Fourier series</p>

\[f(t) = \sum_{j=1}^\infty \left( a_j \cos(\omega_j t) + b_j \sin(\omega_j t) \right)\]

<p>where $\omega_j = \frac{2 \pi j}{T}\,,$ and $T$ is the period, which is assumed
to be 12 months (1 year).
What one usually expects is that high frequency components becomes
less and less important as the frequency increases. Moreover,
those components are generally hidden by statistical noise.
Therefore, only the first few components are considered as relevant.
We will only include the $j=1,2$ component, but you are encouraged to test
what happens when we also include higher frequencies such as $j=3\,.$</p>

<p>Since we want to assess the effect of the law introduction, we will
also include it as a regressor.
As the author, we will include two other regressors:</p>
<ul>
  <li>The total number of kilometers travelled by cars in one month</li>
  <li>The real petrol price.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">)</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">12</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_start</span><span class="p">:</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'tau'</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'rho'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'gamma'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">AR</span><span class="p">(</span><span class="s">'alpha'</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'drivers'</span><span class="p">]))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'mu'</span><span class="p">,</span> <span class="n">alpha</span>
                          <span class="o">+</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                          <span class="o">+</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pm</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                          <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'law'</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'kms'</span><span class="p">]</span><span class="o">/</span><span class="mi">10000</span> <span class="o">+</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'PetrolPrice'</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span> 
                         <span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s">'sigma'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'drivers'</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">idata_start</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nuts_sampler</span><span class="o">=</span><span class="s">'numpyro'</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">80000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">80000</span><span class="p">,</span>
                            <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">idata_start</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s">'rho'</span><span class="p">,</span> <span class="s">'tau'</span><span class="p">,</span> <span class="s">'sigma'</span><span class="p">,</span> <span class="s">'beta'</span><span class="p">,</span> <span class="s">'gamma'</span><span class="p">])</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/structural_ts/trace.webp" alt="" /></p>

<p>The trace shows some minor issue despite the large number of samples.
Let us take a look at the trace summary:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">summary</span><span class="p">(</span><span class="n">idata_start</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s">'rho'</span><span class="p">,</span> <span class="s">'tau'</span><span class="p">,</span> <span class="s">'sigma'</span><span class="p">,</span> <span class="s">'beta'</span><span class="p">,</span> <span class="s">'gamma'</span><span class="p">])</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: right">mean</th>
      <th style="text-align: right">sd</th>
      <th style="text-align: right">hdi_3%</th>
      <th style="text-align: right">hdi_97%</th>
      <th style="text-align: right">mcse_mean</th>
      <th style="text-align: right">mcse_sd</th>
      <th style="text-align: right">ess_bulk</th>
      <th style="text-align: right">ess_tail</th>
      <th style="text-align: right">r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">rho[0]</td>
      <td style="text-align: right">0.519</td>
      <td style="text-align: right">0.106</td>
      <td style="text-align: right">0.322</td>
      <td style="text-align: right">0.721</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">13654</td>
      <td style="text-align: right">20562</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">rho[1]</td>
      <td style="text-align: right">0.463</td>
      <td style="text-align: right">0.107</td>
      <td style="text-align: right">0.258</td>
      <td style="text-align: right">0.661</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">12274</td>
      <td style="text-align: right">20504</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">tau</td>
      <td style="text-align: right">90.382</td>
      <td style="text-align: right">24.43</td>
      <td style="text-align: right">47.543</td>
      <td style="text-align: right">135.72</td>
      <td style="text-align: right">0.322</td>
      <td style="text-align: right">0.228</td>
      <td style="text-align: right">5004</td>
      <td style="text-align: right">6822</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">sigma</td>
      <td style="text-align: right">0.094</td>
      <td style="text-align: right">0.014</td>
      <td style="text-align: right">0.066</td>
      <td style="text-align: right">0.12</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">5372</td>
      <td style="text-align: right">4507</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">beta[0, 0]</td>
      <td style="text-align: right">0.294</td>
      <td style="text-align: right">0.038</td>
      <td style="text-align: right">0.221</td>
      <td style="text-align: right">0.366</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">1059</td>
      <td style="text-align: right">2378</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">beta[0, 1]</td>
      <td style="text-align: right">-0.181</td>
      <td style="text-align: right">0.019</td>
      <td style="text-align: right">-0.216</td>
      <td style="text-align: right">-0.145</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">19573</td>
      <td style="text-align: right">34387</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">beta[1, 0]</td>
      <td style="text-align: right">0.013</td>
      <td style="text-align: right">0.013</td>
      <td style="text-align: right">-0.012</td>
      <td style="text-align: right">0.038</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">22893</td>
      <td style="text-align: right">42960</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">beta[1, 1]</td>
      <td style="text-align: right">-0.147</td>
      <td style="text-align: right">0.014</td>
      <td style="text-align: right">-0.173</td>
      <td style="text-align: right">-0.122</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">0</td>
      <td style="text-align: right">11107</td>
      <td style="text-align: right">35174</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">gamma[0]</td>
      <td style="text-align: right">-0.248</td>
      <td style="text-align: right">0.13</td>
      <td style="text-align: right">-0.493</td>
      <td style="text-align: right">-0.002</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">0.001</td>
      <td style="text-align: right">9738</td>
      <td style="text-align: right">17987</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">gamma[1]</td>
      <td style="text-align: right">-0.063</td>
      <td style="text-align: right">0.27</td>
      <td style="text-align: right">-0.57</td>
      <td style="text-align: right">0.438</td>
      <td style="text-align: right">0.012</td>
      <td style="text-align: right">0.008</td>
      <td style="text-align: right">550</td>
      <td style="text-align: right">1176</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: left">gamma[2]</td>
      <td style="text-align: right">0.786</td>
      <td style="text-align: right">0.147</td>
      <td style="text-align: right">0.506</td>
      <td style="text-align: right">1.056</td>
      <td style="text-align: right">0.005</td>
      <td style="text-align: right">0.003</td>
      <td style="text-align: right">913</td>
      <td style="text-align: right">1953</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<p>Let us now compare the posterior predictive distribution with the observed data.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_start</span><span class="p">:</span>
    <span class="n">idata_start</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">idata_start</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Date'</span><span class="p">],</span> <span class="mi">1000</span><span class="o">*</span><span class="n">idata_start</span><span class="p">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'draw'</span><span class="p">,</span> <span class="s">'chain'</span><span class="p">)),</span>
               <span class="mi">1000</span><span class="o">*</span><span class="n">idata_start</span><span class="p">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">quantile</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'draw'</span><span class="p">,</span> <span class="s">'chain'</span><span class="p">)),</span>
               <span class="n">color</span><span class="o">=</span><span class="s">'lightgray'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'Date'</span><span class="p">],</span> <span class="mi">1000</span><span class="o">*</span><span class="n">idata_start</span><span class="p">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'draw'</span><span class="p">,</span> <span class="s">'chain'</span><span class="p">)))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s">'law'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="s">'Date'</span><span class="p">].</span><span class="nb">min</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s">'k'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s">'Date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'drivers'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/structural_ts/ppc.webp" alt="" /></p>

<p>We can perfectly account for most of the data, so our model seems
capable to almost perfectly reproduce all the relevant features.
Notice that $\gamma_0$ is well below 0, so there are no doubts that,
according to our model, the law introduction had a positive impact
on the driver safety.
On average, the seat belt introduction reduced by 250 the number of
seriously injured drivers.</p>

<h2 id="conclusions">Conclusions</h2>
<p>We have seen how to include external dependencies
such as periodic or trend components as well as autoregressive
patterns in a time series regression by using structural time series.</p>

<h2 id="suggested-readings">Suggested readings</h2>

<ul>
  <li><cite>Box,G.E.P.,Jenkins,G.M.,Reinsel,G.C.(1994).Time Series Analysis: Forecasting and Control.Prentice Hall.</cite></li>
  <li><cite>Harvey, A. C., &amp; Durbin, J. (1986). The Effects of Seat Belt Legislation on British Road Casualties: A Case Study in Structural Time Series Modelling. Journal of the Royal Statistical Society. Series A (General), 149(3), 187–227. https://doi.org/10.2307/2981553</cite></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">watermark</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">p</span> <span class="n">xarray</span>
</code></pre></div></div>
<div class="code">
Last updated: Tue Sep 17 2024
<br />

<br />
Python implementation: CPython
<br />
Python version       : 3.12.6
<br />
IPython version      : 8.24.0
<br />

<br />
xarray: 2024.5.0
<br />

<br />
arviz     : 0.18.0
<br />
pymc      : 5.15.0
<br />
seaborn   : 0.13.2
<br />
pandas    : 2.2.2
<br />
numpy     : 1.26.4
<br />
matplotlib: 3.9.0
<br />
pytensor  : 2.20.0
<br />

<br />
Watermark: 2.4.3
<br />
</div>

  </div><a class="u-url" href="/statistics/structural_time_series" hidden></a>

  <br>
  <div id='autograph'>
          Stippe Jul 22, 2024

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>


  <div class="wrapper">
          <div class='footer-text'>
                  Opinions are mine, mistakes too, and if you find any feel free to report it via mail or via Twitter.
                  <br>
                  Most of the material in the statistics section is an adaptation to Python of some pre-existing model.
                  <br>
                  I have tried to provide the necessary credits, but if you think that a relevant contribution is missing, please let me know.
                  <br>
                  No AI were harmed in creating this blog.
                  <br>
                  This is a blog, not a bakery: there are no cookies here!
                  <br>
                  The top image has been generated with a modified version Dan Gries' code, available at <a href="http://rectangleworld.com/blog/archives/538">http://rectangleworld.com</a>.
          </div>
          <br>

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Data-perspectives</li>
          <li><a class="u-email" href="mailto:dataperspectivesblog@gmail.com">dataperspectivesblog@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/SteffPy" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://stackoverflow.com/users/11065831/stefano" target="_blank" title="stackoverflow">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/thestippe/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://vis.social/@thestippe" target="_blank" title="mastodon">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#mastodon"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

  <script src="/docs/assets/javascript/scroll.js">
  </script>

</html>

