<!DOCTYPE html>
<html lang="en"><head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W9G73E5P44"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W9G73E5P44');
</script>
          <link rel="icon" 
                type="image/png" 
                href="/docs/assets/images/dp_icon.png">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Hierarchical models | Data Perspectives</title>
<meta name="generator" content="Jekyll v3.9.5" />
<meta property="og:title" content="Hierarchical models" />
<meta name="author" content="Data-perspectives" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to implement hierarchies" />
<meta property="og:description" content="How to implement hierarchies" />
<link rel="canonical" href="http://localhost:4000/statistics/hierarchical_models" />
<meta property="og:url" content="http://localhost:4000/statistics/hierarchical_models" />
<meta property="og:site_name" content="Data Perspectives" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-01-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hierarchical models" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Data-perspectives"},"dateModified":"2024-01-30T00:00:00+00:00","datePublished":"2024-01-30T00:00:00+00:00","description":"How to implement hierarchies","headline":"Hierarchical models","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/statistics/hierarchical_models"},"url":"http://localhost:4000/statistics/hierarchical_models"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Data Perspectives" />


<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
<a rel="me" href="https://vis.social/@thestippe" style="display: none;">Mastodon</a>
<link rel="manifest" href="manifest.json">
</head>
<body>

        <div id='upperBar'><header class="site-header">

        <div id='upperBarr'>
        <script src="https://d3js.org/d3.v7.js"></script>
                <div class="wrapper" style="display:flex;"><ul hidden='hidden' id="postList"><li>
                        Philosophy of science;/statistics/on_philosophy_of_science;1
                </li><li>
                        Introduction to this section;/statistics/other_intro;2
                </li><li>
                        Splines regression;/statistics/splines;3
                </li><li>
                        Introduction to non-parametric models;/statistics/nonparametric;4
                </li><li>
                        Introduction to Gaussian processes;/statistics/gaussian_processes;5
                </li><li>
                        The autoregressive model;/statistics/autoregressive;6
                </li><li>
                        Introduction to time series modelling;/statistics/time_series;7
                </li><li>
                        Synthetic control;/statistics/synthetic_control;8
                </li><li>
                        Regression discontinuity ;/statistics/discontinuity_regression;9
                </li><li>
                        Difference in difference;/statistics/difference_in_differences;10
                </li><li>
                        Instrumental variable regression;/statistics/instrumental_variable;11
                </li><li>
                        Randomized controlled trials;/statistics/randomized;12
                </li><li>
                        Causal inference;/statistics/causal_intro;13
                </li><li>
                        Experiment analysis;/statistics/experiment_design;14
                </li><li>
                        Random models and mixed models;/statistics/random_models;15
                </li><li>
                        Introduction to Extreme Values theory;/statistics/extreme_intro;16
                </li><li>
                        Application of survival analysis 1;/statistics/survival_example;17
                </li><li>
                        Introduction to survival analysis;/statistics/survival_analysis;18
                </li><li>
                        Hierarchical models and meta-analysis;/statistics/hierarchical_metaanalysis;19
                </li><li>
                        Hierarchical models;/statistics/hierarchical_models;20
                </li><li>
                        Poisson regression;/statistics/poisson_regression;21
                </li><li>
                        Logistic regression;/statistics/logistic_regression;22
                </li><li>
                        Robust linear regression;/statistics/robust_regression;23
                </li><li>
                        Linear regression with binary input;/statistics/regression_binary_input;24
                </li><li>
                        Introduction to the linear regression;/statistics/regression;25
                </li><li>
                        Model comparison;/statistics/model_averaging;26
                </li><li>
                        Reparametrizing your model;/statistics/reparametrization;27
                </li><li>
                        Predictive checks;/statistics/predictive_checks;28
                </li><li>
                        Trace inspection;/statistics/trace_inspection;29
                </li><li>
                        Introduction to the Bayesian workflow;/statistics/bayesian_workflow;30
                </li><li>
                        Mixture models;/statistics/mixture;31
                </li><li>
                        Multidimensional distributions;/statistics/categories;32
                </li><li>
                        The Gaussian model;/statistics/reals;33
                </li><li>
                        The Negative Binomial model;/statistics/negbin;34
                </li><li>
                        The Poisson model;/statistics/poisson;35
                </li><li>
                        The Beta-Binomial model;/statistics/betabin;36
                </li><li>
                        Common continuous probabilities;/statistics/common_continuous_probabilities;37
                </li><li>
                        Common discrete probabilities;/statistics/common_discrete_probabilities;38
                </li><li>
                        How does MCMC works;/statistics/mcmc_intro;39
                </li><li>
                        Introduction to Bayesian inference;/statistics/bayes_intro;40
                </li><li>
                        Design tricks;/dataviz/design-introduction;41
                </li><li>
                        How to choose a color map;/dataviz/palettes-introduction;42
                </li><li>
                        Introduction to color perception;/dataviz/color-introduction;43
                </li><li>
                        Drawing is redrawing;/dataviz/gender-economist;44
                </li><li>
                        Visual queries;/dataviz/visual-queries;45
                </li><li>
                        The Gestalt principles;/dataviz/gestalt;46
                </li><li>
                        Channel effectiveness;/dataviz/effectiveness;47
                </li><li>
                        Evolutions of the line chart;/dataviz/linechart-evolution;48
                </li><li>
                        Beyond the 1D scatterplot;/dataviz/scatterplot-evolution;49
                </li><li>
                        Perception;/dataviz/perception;50
                </li><li>
                        Fundamental charts;/dataviz/fundamental-charts;51
                </li><li>
                        Marks and channels;/dataviz/marks-channels;52
                </li><li>
                        Data abstraction;/dataviz/data-types;53
                </li><li>
                        Data visualization;/dataviz/dataviz;54
                </li></ul>
                        <div style="display:flex">
                  <a href="/statistics/poisson_regression" class="prev">&#8249;</a>
                  
                                <a href="/"><img class="site-masthead" src="/docs/assets/images/logo_dp.png" alt="Data Perspectives" id="logo" /></a><div id='searchNav' style="flex;">
                                        <input type="search" id="search_0" class="searchBar" onkeydown="searchText()" placeholder="Search">
                                </div>

                                <div hidden='hidden' id="search_focus">0</div>



                        </div><nav class="site-nav" style="display:flex;">
                                <input type="checkbox" id="nav-trigger" class="nav-trigger" />
                                <label for="nav-trigger">
                                        <span class="menu-icon">
                                                <svg viewBox="0 0 18 15" width="18px" height="15px">
                                                        <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
                                                </svg>
                                        </span>
                                </label>

                                <div class="trigger"><a  class="page-link" href="/about">About me</a><a  class="page-link" href="/links">Resources</a>
                                <a href="/statistics/" class="page-link">Up</a>
                                
                                </div>
                        </nav>
                  <a href="/statistics/hierarchical_metaanalysis" class="next">&#8250;</a>
                  
        </div>


        <script src="/docs/assets/javascript/search.js">
        </script>
                </div>

</header>
<div class="progress-container">
    <div class="progress-bar" id="myBar"></div>
    </div>
        </div>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
          <div id='topPage'></div>
        <a href='/index'>
<img src="/docs/assets/images/background_resized.webp" alt="backround" style="margin:auto;display:block;width:1200px">

</a>
    <h1 class="post-title p-name" itemprop="name headline">Hierarchical models</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-01-30T00:00:00+00:00" itemprop="datePublished">
        Jan 30, 2024
      </time></p>
    <p class="post-meta"> Reading time: <span class="reading-time" title="Estimated read time">
  
  9&prime;
</span>
</p>
  </header>
  <br>

  <div class="post-content e-content" itemprop="articleBody">
    <p>There are many circumstances where your data are somehow connected,
but cannot be treated as iid.
As an example, when you compare clinical studies on the effectiveness
of a medicine, data originated from
different studies will likely involve different inclusion policies as
well as different hospital setup.
However, it is reasonable to assume that parameters describing
different studies are related.</p>

<div class="emphbox">
In Bayesian statistics, a common approach
in these situations is to assume that the parameters are sampled from
a common prior distribution.
</div>

<p>Mathematically speaking, you assume that</p>

\[Y_i \sim P(\theta_i)\]

<p>so each observation will be described by its own parameter. However,
the parameters are considered as iid</p>

\[\theta_i \sim P'(\phi)\]

<p>This kind of model strictly belongs to the Bayesian framework, as in the frequentist
one the parameters $\theta_i$ are numbers, so you can either treat them
as different (unpooled) or they are sampled from the same distribution (pooled).</p>

<p>Let us take a look at this kind of model with an example.</p>

<h2 id="spacex-analysis">SpaceX analysis</h2>

<p>In the following we will consider the launches from the four
main launch vehicles: Falcon 1, Falcon 9, Falcon Heavy and Starship.
For the sake of simplicity, we will treat as identical
rockets of different variants within the same family.
Below we provide the relevant statistics for the different launchers.</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: left">Mission</th>
      <th style="text-align: right">Number</th>
      <th style="text-align: right">successes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: left">Falcon 1</td>
      <td style="text-align: right">5</td>
      <td style="text-align: right">2</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">Falcon 9</td>
      <td style="text-align: right">304</td>
      <td style="text-align: right">301</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Falcon Heavy</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">9</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">Starship</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">5</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="n">st</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">df_spacex</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s">'Mission'</span><span class="p">:</span> <span class="p">[</span><span class="s">'Falcon 1'</span><span class="p">,</span> <span class="s">'Falcon 9'</span><span class="p">,</span> <span class="s">'Falcon Heavy'</span><span class="p">,</span> <span class="s">'Starship'</span><span class="p">],</span> <span class="s">'N'</span><span class="p">:</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">304</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span> <span class="s">'y'</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">301</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">]})</span>

<span class="n">df_spacex</span><span class="p">[</span><span class="s">'mu'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_spacex</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">]</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="no-pooling">No pooling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">spacex_model_no_pooling</span><span class="p">:</span>  
  <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Beta</span><span class="p">(</span><span class="s">'theta'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">].</span><span class="n">values</span><span class="p">))</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Binomial</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
                  <span class="n">observed</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span>

<span class="n">pm</span><span class="p">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">spacex_model_no_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/model_unpooled.webp" alt="The structure of the unpooled model" /></p>

<p>In the above diagram we see that each of the four vehicle has its own
parameter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">spacex_model_no_pooling</span><span class="p">:</span>
  <span class="n">trace_spacex_no_pooling</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_spacex_no_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/trace_unpooled.webp" alt="The trace of the unpooled model" /></p>

<p>In the above block, we increased the “target_accept” parameter in order to avoid
numerical issues.
The trace looks fine, but let us now take a better look at the estimated parameters.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_spacex_no_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/forest_unpooled.webp" alt="The forest plot of the unpooled model" /></p>

<p>The parameters make sense, and the Falcon 1 as well as the Starship are very
unconstrained, due to the small number of launches.
Let us now take a look at the pooled model.</p>

<h3 id="full-pooling">Full pooling</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">spacex_model_full_pooling</span><span class="p">:</span>  
  <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Beta</span><span class="p">(</span><span class="s">'theta'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Binomial</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
                  <span class="n">observed</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span>

<span class="n">pm</span><span class="p">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">spacex_model_full_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/model_pooled.webp" alt="The structure of the pooled model" /></p>

<p>In this model, all the launches are treated as sampled from a common
iid, and we therefore have only one parameter for all the launch vehicle.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">spacex_model_full_pooling</span><span class="p">:</span>
  <span class="n">trace_spacex_full_pooling</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_spacex_full_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/trace_pooled.webp" alt="The trace of the pooled model" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_spacex_full_pooling</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/forest_pooled.webp" alt="The forest plot of the pooled model" /></p>

<p>In this case the single parameter is almost entirely above 0.94,
so any launch should succeed with a probability higher than the 94%.
Would you to bet that a Falcon 1 would succeed? I honestly wouldn’t,
but this is what you should do according to this model.</p>

<h3 id="hierarchical-model">Hierarchical model</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">spacex_model_hierarchical</span><span class="p">:</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s">"alpha"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">HalfNormal</span><span class="p">(</span><span class="s">"beta"</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">"mu"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">/</span><span class="p">(</span><span class="n">alpha</span><span class="o">+</span><span class="n">beta</span><span class="p">))</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Beta</span><span class="p">(</span><span class="s">'theta'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">].</span><span class="n">values</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Binomial</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'N'</span><span class="p">].</span><span class="n">values</span><span class="p">,</span>
                  <span class="n">observed</span><span class="o">=</span><span class="n">df_spacex</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="n">values</span><span class="p">)</span>

<span class="n">pm</span><span class="p">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">spacex_model_hierarchical</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/model_hierarchical.webp" alt="The structure of the hierarchical model" /></p>

<p>In this case, each vehicle has its own parameter. The parameters are
however sampled according to a Beta distribution, with priors
$\alpha$ and $\beta\,.$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">spacex_model_hierarchical</span><span class="p">:</span>
    <span class="n">trace_spacex_hierarchical</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">trace_spacex_hierarchical</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/trace_hierarchical.webp" alt="The trace of the hierarchical model" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">trace_spacex_hierarchical</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="s">'theta'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/forest_hierarchical.webp" alt="The forest plot of the hierarchical model" /></p>

<p>These estimates are similar to the unpooled model, they are however
closer one to the other ones.
This happens because the hierarchical model allow us to share information
across the variables.</p>

<p>One of the most relevant features of hierarchical models, is that they allow us to make predictions for unobserved variables
with unknown parameters.
Let us assume that SpaceX produces a new launcher, this model allows us
to estimate its success probability.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">spacex_model_hierarchical</span><span class="p">:</span>
    <span class="n">theta_new</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Beta</span><span class="p">(</span><span class="s">'th_new'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
    <span class="n">ppc_new</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">trace_spacex_hierarchical</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s">'th_new'</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ppc_new</span><span class="p">.</span><span class="n">posterior_predictive</span><span class="p">[</span><span class="s">'th_new'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/hierarchical_new_theta.webp" alt="The probability distribution for a new theta" /></p>

<p>We can moreover estimate the average success rate for any SpaceX
vehicle.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map_mu</span> <span class="o">=</span> <span class="n">st</span><span class="p">.</span><span class="n">mode</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">trace_spacex_hierarchical</span><span class="p">.</span><span class="n">posterior</span><span class="p">[</span><span class="s">"mu"</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))).</span><span class="n">mode</span><span class="o">/</span><span class="mi">100</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="n">plot_posterior</span><span class="p">(</span><span class="n">trace_spacex_hierarchical</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s">"mu"</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sa">f</span><span class="s">'MAP: </span><span class="si">{</span><span class="n">map_mu</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/hierarchical/hierarchical_mu.webp" alt="The probability distribution of a success" /></p>

<p>This estimate is much more generous than the pooled one,
as it properly takes into account the failure rates of less successful
models.</p>

<p>We also reported the Maximum A Posteriori (MAP) estimate for the above parameter,
as it is a better point estimate than the mean for non-symmetric distributions
as the one above.</p>

<h2 id="conclusions">Conclusions</h2>

<p>We discussed how hierarchical models allow us to share information
across the variables and to make predictions for new, unobserved, variables.
In the next post we will discuss a very important application
of hierarchical models to meta-analysis.</p>

  </div><a class="u-url" href="/statistics/hierarchical_models" hidden></a>

  <div>
          
          
  </div>

  <br>
  <div id='autograph'>
          Stippe Jan 30, 2024

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>


  <div class="wrapper">
          <div class='footer-text'>

                  No AI were harmed in creating this blog.
                  <br>
                  This is a blog, not a bakery: there are no cookies here!
                  <br>
                  The top image has been generated with a modified version Dan Gries' code, available at <a href="http://rectangleworld.com/blog/archives/538">http://rectangleworld.com</a>.
          </div>
          <br>

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Data-perspectives</li>
          <li><a class="u-email" href="mailto:dataperspectivesblog@gmail.com">dataperspectivesblog@gmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/SteffPy" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://stackoverflow.com/users/11065831/stefano" target="_blank" title="stackoverflow">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/thestippe/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://vis.social/@thestippe" target="_blank" title="mastodon">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#mastodon"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

  <script src="/docs/assets/javascript/scroll.js">
  </script>

</html>

