<!DOCTYPE html>
<html lang="en"><head>
          <link rel="icon" 
                type="image/png" 
                href="/docs/assets/images/dp_icon.png">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Trace evaluation | Data Perspectives</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Trace evaluation" />
<meta name="author" content="Stippe" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="How to spot major numerical issues" />
<meta property="og:description" content="How to spot major numerical issues" />
<link rel="canonical" href="http://localhost:4000/trace/" />
<meta property="og:url" content="http://localhost:4000/trace/" />
<meta property="og:site_name" content="Data Perspectives" />
<meta property="og:image" content="http://localhost:4000/docs/assets/images/trace/rank_bad3.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-08-23T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/docs/assets/images/trace/rank_bad3.jpg" />
<meta property="twitter:title" content="Trace evaluation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Stippe"},"dateModified":"2023-08-23T00:00:00+02:00","datePublished":"2023-08-23T00:00:00+02:00","description":"How to spot major numerical issues","headline":"Trace evaluation","image":"http://localhost:4000/docs/assets/images/trace/rank_bad3.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/trace/"},"url":"http://localhost:4000/trace/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Data Perspectives" />

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>


<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML">
</script>
</head>
<body><header class="site-header">

<div>
  <div class="wrapper" style="display:flex;"><a href="/"><img class="site-masthead" src="/docs/assets/images/logo_dp.png" alt="Data Perspectives" /></a><nav class="site-nav" style="display:flex;">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about">About me</a><a class="page-link" href="/index">Home</a><a class="page-link" href="/notes">List of the notes</a><a class="page-link" href="/links">Some useful resources</a></div>
      </nav></div>
</div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Trace evaluation</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-08-23T00:00:00+02:00" itemprop="datePublished">
        Aug 23, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Up to now we limited ourselves to a visual assessment of the trace quality.
Here we will give some explicit example of some problem in the sampling
and we will provide some tool to investigate the issues in the sampling.
We will also give some recipes in order to improve the quality of our MCMC traces.</p>

<p>Up to now we simply used the PyMC sample function as</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">my_model</span><span class="p">:</span>
   <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">()</span>
</code></pre></div></div>

<p>We did this for the sake of simplicity, but it is not the best way to proceed
when one deals with real applications. As we have seen, when writing a report,
one should always provide:</p>

<ul>
  <li>the number of chains</li>
  <li>the number of warm-up steps</li>
  <li>the number of draws</li>
</ul>

<p>In order to ensure the reproducibility of the results, one should also provide
the random seed of the sampler.</p>

<p>A better approach is</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">n_chains</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_draws</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">n_tune</span> <span class="o">=</span> <span class="mi">5000</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="k">with</span> <span class="n">my_model</span><span class="p">:</span>
   <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="n">n_draws</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="n">n_tune</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="n">n_chains</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
</code></pre></div></div>

<p>Gelman’s suggestion is to use n_tune equal to n_draws, as this is
the best compromise between time and precision.</p>

<p>The choice of n_draws generally depends on the problem, but 
<a href="https://www.nature.com/articles/s41562-021-01177-7">Kruschke</a>
recommends to choose it in such a way that the Effective Sample Size,
(which can be inferred by the arviz summary function) is at least 10000,
so to ensure the stability of the HDI estimate.</p>

<p>The default value of four is generally a good starting point for the chain number.
A smaller number would not make reliable the estimate for the $\hat{R}$ statistics,
that we will explain in this post.</p>

<p>In this post I tried and force PyMC to do its worst in the sampling.
This is quite hard, as the default NUTS sampler is very good, so I had to tune by hand the sampler in
some crazy (and obviously quite bad) ways.
So don’t focus on the models or on the sampling options, but you should rather focus on the traces.</p>

<p>Let us first setup our environment</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="n">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="n">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">from</span> <span class="n">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span> 
<span class="kn">from</span> <span class="n">pytensor.tensor.math</span> <span class="kn">import</span> <span class="n">gammaln</span>
<span class="kn">from</span> <span class="n">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="n">itables</span> <span class="kn">import</span> <span class="n">init_notebook_mode</span>
<span class="kn">import</span> <span class="n">pymc.sampling_jax</span> <span class="k">as</span> <span class="n">pmj</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">default_rng</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="sh">"</span><span class="s">seaborn-v0_8-darkgrid</span><span class="sh">"</span><span class="p">)</span>

</code></pre></div></div>

<p>We can now proceed with the first model</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_hurricanes</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">data/frequency-north-atlantic-hurricanes.csv</span><span class="sh">'</span><span class="p">)</span>

<span class="n">y_obs</span> <span class="o">=</span> <span class="n">df_hurricanes</span><span class="p">[</span><span class="sh">"</span><span class="s">Number of US Hurricanes (HUDRAT, NOAA)</span><span class="sh">"</span><span class="p">].</span><span class="nf">dropna</span><span class="p">().</span><span class="n">values</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model_hurricanes</span><span class="p">:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Gamma</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Poisson</span><span class="p">(</span><span class="sh">"</span><span class="s">y</span><span class="sh">"</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">y_obs</span><span class="p">)</span>
<span class="n">trace_hurricanes</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">return_inferencedata</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                  <span class="n">step</span><span class="o">=</span><span class="p">[</span><span class="n">pm</span><span class="p">.</span><span class="nc">HamiltonianMC</span><span class="p">(</span><span class="n">adapt_step_size</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">step_scale</span><span class="o">=</span><span class="mi">05</span><span class="p">,</span>
                                  <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)],</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">trace_hurricanes</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad1.jpg" alt="Bad trace one" /></p>

<p>In this case the issue is quite obvious:
the traces are simply stuck at the initial points.
This won’t easily happen with the NUTS sampler, but if you are using any adaptive
sampler you should simply run more tuning draws or reduce the step.</p>

<p>Let us use the previous model to illustrate another possible problem:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_hurricanes</span><span class="p">:</span>
    <span class="n">trace_hurricanes0</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
                                  <span class="n">return_inferencedata</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                  <span class="n">step</span><span class="o">=</span><span class="p">[</span><span class="n">pm</span><span class="p">.</span><span class="nc">HamiltonianMC</span><span class="p">(</span><span class="n">adapt_step_size</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">step_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                         <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)],</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">trace_hurricanes0</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad2.jpg" alt="Bad trace two" /></p>

<p>Here we clearly see four non-stationary chains. Also in this case you should run more tuning draws and likely more draws in general. Also the acceptance ratio is clearly too high, and we could reduce it (as a general recommendation 0.65 should be optimal).</p>

<p>This kind of issue is very easy to spot, but there are other kind of issue which
are less easy to spot by a simple visual inspection of the trace:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model_hurricanes</span><span class="p">:</span>
    <span class="n">trace_hurricanes1</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                                  <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> 
                                  <span class="n">chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">r</span>
                                  <span class="n">eturn_inferencedata</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                  <span class="n">step</span><span class="o">=</span><span class="p">[</span><span class="n">pm</span><span class="p">.</span><span class="nc">HamiltonianMC</span><span class="p">(</span><span class="n">adapt_step_size</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">step_scale</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                         <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)],</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">trace_hurricanes1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad3.jpg" alt="Bad trace two" /></p>

<p>Globally the traces may appear good, but by a more accurate inspection one
can see that, on a region of some percent of the entire sample,
the average is different from the global average.
This is synonym of non-negligible autocorrelation, which may lead to
a wrong variance estimate.
Let us see some useful tools to easily spot this.</p>

<p>First of all, we should look at the autocorrelation plot</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">plot_autocorr</span><span class="p">(</span><span class="n">trace_hurricanes1</span><span class="p">)</span>
</code></pre></div></div>
<p><img src="/docs/assets/images/trace/acorr_bad3.jpg" alt="Bad trace two" /></p>

<p>The grey band shows the estimate of the autocorrelation coefficients above the
maximum shown point, and it is quite large.
We can also look at the trace summary</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">summary</span><span class="p">(</span><span class="n">trace_hurricanes1</span><span class="p">)</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left"> </th>
      <th style="text-align: right">mean</th>
      <th style="text-align: right">sd</th>
      <th style="text-align: right">hdi_3%</th>
      <th style="text-align: right">hdi_97%</th>
      <th style="text-align: right">mcse_mean</th>
      <th style="text-align: right">mcse_sd</th>
      <th style="text-align: right">ess_bulk</th>
      <th style="text-align: right">ess_tail</th>
      <th style="text-align: right">r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">mu</td>
      <td style="text-align: right">1.748</td>
      <td style="text-align: right">0.102</td>
      <td style="text-align: right">1.552</td>
      <td style="text-align: right">1.936</td>
      <td style="text-align: right">0.003</td>
      <td style="text-align: right">0.002</td>
      <td style="text-align: right">1418</td>
      <td style="text-align: right">814</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<p>The ESS is very small, and this should warn us.
This is even more clear by looking at the rank plot, where in a good trace
we would expect that all the bars show equal height</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="nf">plot_rank</span><span class="p">(</span><span class="n">trace_hurricanes1</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/rank_bad3.jpg" alt="Bad trace two" /></p>

<p>We can see that some bars are far away from the black dashed line,
and this indicates that trace is not reliable.</p>

<p>Let us look at some less trivial problem:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_a</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">https://raw.githubusercontent.com/Gajapathy-Selvaraj/Stock_Market_Datasets_NSE/main/NIFTY_50(INDEX)from2000.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">df_a</span><span class="p">[</span><span class="sh">'</span><span class="s">LogRet</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">df_a</span><span class="p">[</span><span class="sh">'</span><span class="s">Close</span><span class="sh">'</span><span class="p">]).</span><span class="nf">diff</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">df_a</span><span class="p">[</span><span class="sh">'</span><span class="s">LogRet</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">:]</span>
<span class="kn">from</span> <span class="n">variance_gamma</span> <span class="kn">import</span> <span class="n">VarianceGamma</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">vg0_model</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">MvNormal</span><span class="p">(</span><span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">cov</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]))</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Gamma</span><span class="p">(</span><span class="sh">'</span><span class="s">v</span><span class="sh">'</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Gamma</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Deterministic</span><span class="p">(</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Deterministic</span><span class="p">(</span><span class="sh">'</span><span class="s">variance</span><span class="sh">'</span><span class="p">,</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">theta</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    
    <span class="n">logret</span> <span class="o">=</span> <span class="nc">VarianceGamma</span><span class="p">(</span><span class="sh">'</span><span class="s">logret</span><span class="sh">'</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span><span class="n">observed</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
<span class="n">tr_vg</span> <span class="o">=</span> <span class="n">pmj</span><span class="p">.</span><span class="nf">sample_numpyro_nuts</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">tr_vg</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">v</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad4.jpg" alt="Bad trace four" /></p>

<p>This is of course a terrible trace. We have sampled only 300 draws in order to make
it evident, but it remains also with a higher number of draws.
The main issue in this model is that the two plotted parameters are highly
correlated, as they equally contribute to the variance.
The best choice in this case is a re-parametrization of the model,
in such a way that one can disentangle the two parameters and allow the sampler
to easily do its job.
This may also happen when one has pathologies in the model
or when uses a too broad prior for a poorly constrained parameter.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Cauchy</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">HalfCauchy</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad6.jpg" alt="Bad trace five" /></p>

<p>There is one point which lies far away from the other points,
so choosing a less generous prior would help in this case.</p>

<p>The last example that we will see is more tricky, as it is not a problem,
theoretically.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">iris</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">https://gist.githubusercontent.com/netj/8836201/raw/6f9306ad21398ea43cba4f7d537619d0e07d5ae3/iris.csv</span><span class="sh">'</span><span class="p">)</span>

<span class="n">rng1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">default_rng</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>

<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">mix_model</span><span class="p">:</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Exponential</span><span class="p">(</span><span class="sh">'</span><span class="s">sigma</span><span class="sh">'</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Normal</span><span class="p">(</span><span class="sh">'</span><span class="s">mu</span><span class="sh">'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">pi</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Dirichlet</span><span class="p">(</span><span class="sh">'</span><span class="s">pi</span><span class="sh">'</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">.</span><span class="nf">dist</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nc">Mixture</span><span class="p">(</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">pi</span><span class="p">,</span> <span class="n">comp_dists</span> <span class="o">=</span> <span class="n">phi</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">iris</span><span class="p">[</span><span class="sh">'</span><span class="s">petal.length</span><span class="sh">'</span><span class="p">])</span>
    <span class="n">tr_mix</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">tune</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng1</span><span class="p">)</span>
<span class="n">az</span><span class="p">.</span><span class="nf">plot_trace</span><span class="p">(</span><span class="n">tr_mix</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/trace/trace_bad5.jpg" alt="Bad trace six" /></p>

<p>In this very simple model the trace simply got stuck into a low probability region
for a while and then performed a jump to a different region.
This kind of problem is quite rare, but when it happens it may be hard to spot
unless you see the jump as in this case.</p>

<p>If you use many traces it may be easier to spot, and possible solutions
are re-parametrizations of your model, drawing longer samples or increasing
the acceptance ratio.</p>

  </div><a class="u-url" href="/trace/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Stippe</li>
          <li><a class="u-email" href="mailto:smaurizio87@protonmail.com">smaurizio87@protonmail.com</a></li>
        </ul>
      </div>
      <div class="footer-col">
        <p></p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/SteffPy" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://stackoverflow.com/users/11065831/stefano" target="_blank" title="stackoverflow">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#stackoverflow"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://github.com/thestippe/" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>

