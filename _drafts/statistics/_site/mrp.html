<p>MRP stands for <strong>Multilevel Regression and Post-stratification</strong>, and is a very
popular way to make inference based on surveys, especially with the ones
with selected samples.</p>

<p>The main issue with sampling is how to deal with non-responders,
and MrP allows you to correct for this issue if it is properly done.
You can consider MrP as a two-stage procedure:</p>

<ol>
  <li>Perform a multilevel regression on your sample</li>
  <li>re-weight the probabilities of each of your subpopulations with weights extracted from a census to obtain the population probability.</li>
</ol>

<p>Using multilevel regression allows you to share information across subpopulations, so the variance distribution will have a smoother behavior across them with respect to a single-level model.
Post-stratification is instead needed because, even if your sample is a random sample of your population,
non-respondence might be no random at all, and this could introduce a sampling bias into the respondent sample.
You should however always be very careful with surveys. In fact, 
as J. Ornstein reminds us in <a href="https://link.springer.com/chapter/10.1007/978-3-031-12982-7_5">Causality in Policy Studies</a>:</p>

<p><br /></p>

<blockquote>
  <p>MRP is not a panacea, and one should be skeptical of estimates produced from small-sample surveys, 
regardless of how they are operationalized.</p>

  <p>Joseph T. Ornstein</p>
</blockquote>

<p><br /></p>

<p>In the following we will use MRP to analyze the data collected in 
<a href="https://www.sciencedirect.com/science/article/pii/S2352340919304986#bib10">this study on conspiracy believes of the Italian population</a>,
and the dataset can be downloaded from
<a href="https://ars.els-cdn.com/content/image/1-s2.0-S2352340919304986-mmc1.zip">this link</a>.
We will adapt the MRP model as shown in
<a href="https://bookdown.org/jl5522/MRP-case-studies/">“MRP case studies” by Juan Lopez-Martin, Justin H. Phillips, and Andrew Gelman</a>.</p>

<h2 id="data-import-and-initial-transformations">Data import and initial transformations</h2>

<p>In this first part we will re-organize the data prepare the datasets
for the fit.
This part is quite technical, 
and I decided to keep it because it might be useful
to see that the data preparation can be a rather cumbersome procedure,
but the uninterested reader can safely skip it.
The population dataset has been obtained from the
<a href="https://esploradati.istat.it/databrowser/#/it/dw/categories/IT1,Z0820EDU,1.0/DCCV_POPTIT1_UNT2020/IT1,52_1194_DF_DCCV_POPTIT1_UNT2020_1,1.0">ISTAT -the official italian statistics institute- webpage</a>.</p>

<p>We used this dataset because, as it is well known, education is a very relevant factor in
conspiracy beliefs, so we used the dataset where the italian population
is given by age, sex, geographic area and education level.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="n">sns</span>
<span class="kn">import</span> <span class="nn">pymc</span> <span class="k">as</span> <span class="n">pm</span>
<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="n">az</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">df_anag</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'data/istruzione.csv'</span><span class="p">)</span>

<span class="n">df_anag</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: right">Anno</th>
      <th style="text-align: left">Regione</th>
      <th style="text-align: left">Sesso</th>
      <th style="text-align: left">Fascia</th>
      <th style="text-align: right">Elementare</th>
      <th style="text-align: right">Media</th>
      <th style="text-align: right">Professionale</th>
      <th style="text-align: right">Maturita</th>
      <th style="text-align: right">Laurea</th>
      <th style="text-align: right">Totale</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">15-24 anni</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">667</td>
      <td style="text-align: right">90</td>
      <td style="text-align: right">518</td>
      <td style="text-align: right">63</td>
      <td style="text-align: right">1350</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">25-29 anni</td>
      <td style="text-align: right">6</td>
      <td style="text-align: right">121</td>
      <td style="text-align: right">80</td>
      <td style="text-align: right">300</td>
      <td style="text-align: right">190</td>
      <td style="text-align: right">698</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">30-34 anni</td>
      <td style="text-align: right">8</td>
      <td style="text-align: right">184</td>
      <td style="text-align: right">84</td>
      <td style="text-align: right">271</td>
      <td style="text-align: right">189</td>
      <td style="text-align: right">737</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">35-39 anni</td>
      <td style="text-align: right">9</td>
      <td style="text-align: right">227</td>
      <td style="text-align: right">92</td>
      <td style="text-align: right">282</td>
      <td style="text-align: right">201</td>
      <td style="text-align: right">811</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: right">2020</td>
      <td style="text-align: left">N</td>
      <td style="text-align: left">M</td>
      <td style="text-align: left">40-44 anni</td>
      <td style="text-align: right">20</td>
      <td style="text-align: right">298</td>
      <td style="text-align: right">108</td>
      <td style="text-align: right">356</td>
      <td style="text-align: right">184</td>
      <td style="text-align: right">965</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_spss</span><span class="p">(</span><span class="s">'./data/dib_104144_dataset.sav'</span><span class="p">)</span>

<span class="n">df_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s">'region'</span><span class="p">,</span> <span class="s">'sex'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'edu'</span><span class="p">,</span> <span class="s">'cb11'</span><span class="p">]]</span>

<span class="n">df_data</span><span class="p">[</span><span class="s">'y0'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="s">'cb11'</span><span class="p">].</span><span class="n">replace</span><span class="p">({</span><span class="s">'Completely disagree'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">'Completely agree'</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>

<span class="n">df_data</span><span class="p">.</span><span class="n">to_markdown</span><span class="p">()</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: right"> </th>
      <th style="text-align: left">region</th>
      <th style="text-align: left">sex</th>
      <th style="text-align: right">age</th>
      <th style="text-align: left">edu</th>
      <th style="text-align: left">cb11</th>
      <th style="text-align: right">y0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right">0</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">37</td>
      <td style="text-align: left">degree</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">1</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">20</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">2</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">19</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">3</td>
      <td style="text-align: left">Center</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">19</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right">4</td>
      <td style="text-align: left">North</td>
      <td style="text-align: left">Female</td>
      <td style="text-align: right">31</td>
      <td style="text-align: left">high school</td>
      <td style="text-align: left">Completely disagree</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<p>The target variable is the answer to the question
“Vaccines are useless and dangerous, they are only instrumental to the financial interests of pharmaceutical
companies”
from <a href="https://www.sciencedirect.com/science/article/abs/pii/S0191886918303751">Avoidant attachment style and conspiracy ideation</a>
and the answer goes from 1 (completely disagree) to 5 (completely agree).
We will transform it and make it binary, and the transformed variable will be 1
if the respondent answered 4 or 5 to the above question.
As regressors, we will use as starting point:</p>
<ul>
  <li>the region, marked N for North, C for center and M for south or islands.</li>
  <li>the sex (M/F)</li>
  <li>the age (integer)</li>
  <li>the education level</li>
</ul>

<p>Let us look to the education</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'edu'</span><span class="p">).</span><span class="n">count</span><span class="p">()[</span><span class="s">'region'</span><span class="p">]</span>
</code></pre></div></div>

<div class="code">
edu
<br />
0.0                    6
<br />
degree               306
<br />
high school          350
<br />
no qualifications      2
<br />
post graduate         73
<br />
primary school         3
<br />
secondary school      34
<br />
Name: region, dtype: int64
<br />
</div>

<p>Since in Italy the vast majority of the adult population has at least a high school degree,
we will only use the university degree as regressor, otherwise we wouldn’t
have a sufficient number of subject in order to get a reliable estimate of the regression
coefficients.</p>

<p>Let us now stratify the age, since it doesn’t make much sense to the bare age as regressor.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_a0</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'15-24 anni'</span><span class="p">,</span> <span class="s">'25-29 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a1</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'30-34 anni'</span><span class="p">,</span> <span class="s">'35-39 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a2</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'40-44 anni'</span><span class="p">,</span> <span class="s">'45-49 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a3</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'50-54 anni'</span><span class="p">,</span> <span class="s">'55-59 anni'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_a4</span> <span class="o">=</span> <span class="n">df_anag</span><span class="p">[</span><span class="n">df_anag</span><span class="p">[</span><span class="s">'Fascia'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'60-64 anni'</span><span class="p">,</span> <span class="s">'65 anni e più'</span><span class="p">])].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[[</span><span class="s">'Maturita'</span><span class="p">,</span> <span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">]].</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">df_a0</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">df_a1</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">df_a2</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">df_a3</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">df_a4</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">df_anag_new</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_a0</span><span class="p">,</span> <span class="n">df_a1</span><span class="p">,</span> <span class="n">df_a2</span><span class="p">,</span> <span class="n">df_a3</span><span class="p">,</span> <span class="n">df_a4</span><span class="p">])</span>
</code></pre></div></div>

<p>We can now transform the sample dataframe</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_fit</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s">'region'</span><span class="p">,</span> <span class="s">'sex'</span><span class="p">,</span> <span class="s">'age'</span><span class="p">,</span> <span class="s">'edu'</span><span class="p">,</span> <span class="s">'y0'</span><span class="p">]]</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'region'</span><span class="p">]</span><span class="o">==</span><span class="s">'Center'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'region'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'South'</span><span class="p">,</span> <span class="s">'Islands'</span><span class="p">])).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'sex'</span><span class="p">]</span><span class="o">==</span><span class="s">'Male'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="s">'edu'</span><span class="p">].</span><span class="n">isin</span><span class="p">([</span><span class="s">'degree'</span><span class="p">,</span> <span class="s">'post graduate'</span><span class="p">]).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_fit</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'age'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># if the age is not reported "age" has value -99
</span>
<span class="k">def</span> <span class="nf">map_age</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">30</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">40</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>

<span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[</span><span class="s">'age'</span><span class="p">].</span><span class="nb">map</span><span class="p">(</span><span class="n">map_age</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_fit</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'y0'</span><span class="p">].</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="explorative-analysis">Explorative analysis</h2>

<p>We can now look for differences between the survey sample and the italian population.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_anag_new</span><span class="p">[</span><span class="s">'NoLaurea'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anag_new</span><span class="p">[</span><span class="s">'Totale'</span><span class="p">]</span><span class="o">-</span><span class="n">df_anag_new</span><span class="p">[</span><span class="s">'Laurea'</span><span class="p">]</span>
<span class="n">df_anag_deg</span> <span class="o">=</span> <span class="n">df_anag_new</span><span class="p">.</span><span class="n">melt</span><span class="p">(</span><span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s">'Laurea'</span><span class="p">,</span> <span class="s">'NoLaurea'</span><span class="p">],</span>
                               <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">,</span> <span class="s">'Sesso'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'Totale'</span><span class="p">],</span>
                               <span class="n">value_name</span><span class="o">=</span><span class="s">'number'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">==</span><span class="s">'Laurea'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'frac'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'number'</span><span class="p">]</span><span class="o">/</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'number'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span>

<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="s">'C'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="s">'M'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Sesso'</span><span class="p">]</span><span class="o">==</span><span class="s">'M'</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">df_means_by_group</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">]).</span><span class="n">mean</span><span class="p">().</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df_n_by_group</span> <span class="o">=</span> <span class="n">df_fit</span><span class="p">[[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">]].</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s">'Centro'</span><span class="p">,</span> <span class="s">'Mezzogiorno'</span><span class="p">,</span> <span class="s">'is_male'</span><span class="p">,</span> <span class="s">'Gruppo'</span><span class="p">,</span> <span class="s">'has_degree'</span><span class="p">]).</span><span class="n">count</span><span class="p">().</span><span class="n">reset_index</span><span class="p">()</span>
</code></pre></div></div>

<p>We prepared two auxiliary datasets, and the last one counts
how many units for each stratum are present in the dataset.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'y'</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">).</span><span class="nb">sum</span><span class="p">()</span>
</code></pre></div></div>
<div class="code">
0
</div>

<p>There is at least one unit for each stratum, and this is a first indicator
that our age groups are large enough.
Let us compare the population percentages for each regression variable
with the corresponding sample percentage.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="s">'C'</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> <span class="s">'M'</span><span class="p">,</span> <span class="s">'N'</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Gruppo'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Gruppo'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Gruppo'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s">'Population'</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'has_degree'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'has_degree'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Sample'</span><span class="p">)</span>

<span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">))</span>
<span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'Regione'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Regione'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'Regione'</span><span class="p">]).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'Regione'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>

<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'frac'</span><span class="p">].</span><span class="n">reset_index</span><span class="p">().</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'frac'</span><span class="p">:</span> <span class="s">'y'</span><span class="p">}),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'is_male'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="p">.</span><span class="n">barplot</span><span class="p">((</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">]</span><span class="o">/</span><span class="n">df_n_by_group</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'is_male'</span><span class="p">).</span><span class="nb">sum</span><span class="p">()[</span><span class="s">'y'</span><span class="p">].</span><span class="nb">sum</span><span class="p">()).</span><span class="n">reset_index</span><span class="p">(),</span>
             <span class="n">x</span><span class="o">=</span><span class="s">'is_male'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>


<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/percentages.webp" alt="" /></p>

<p>There are very large differences between the sample and the population,
and this might lead to an unreliable estimate for our target variable.</p>

<h2 id="fitting-the-model">Fitting the model</h2>

<p>We will use a hierarchical model with the previously mentioned regressors,
and the implemented model is the following one:</p>

\[\begin{align*}
logit P(y^i=1) = &amp;  \theta^i \\
\\
\theta^i = &amp; \alpha + \gamma_{C} X^i_{Centro}+ \gamma_{M} X^i_{Mezzogiorno} \\
&amp; + \beta_{Male} X^i_{Male} + \beta_{Group}^{g[i]}+ \beta_{Degree}^{g[i]} X^{i}_{Degree} \\
&amp; + \beta_{Male, Edu}^{g[i]}X^i_{Male} X^{i}_{Degree}
\end{align*}\]

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">with</span> <span class="n">pm</span><span class="p">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">sigma_group</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_group'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sigma_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_degree'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">sigma_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s">'sigma_male_edu'</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">alpha_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha_degree'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">alpha_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'alpha_male_edu'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">beta_group_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_group_std'</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_group</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_group'</span><span class="p">,</span> <span class="n">sigma_group</span><span class="o">*</span><span class="n">beta_group_std</span><span class="p">)</span>
    <span class="n">beta_male</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_male'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">beta_male_edu_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_male_edu_std'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_degree_std</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'beta_degree_std'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">].</span><span class="n">drop_duplicates</span><span class="p">()))</span>
    <span class="n">beta_degree</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_degree'</span><span class="p">,</span> <span class="n">alpha_degree</span><span class="o">+</span><span class="n">beta_degree_std</span><span class="o">*</span><span class="n">sigma_degree</span><span class="p">)</span>
    <span class="n">beta_male_edu</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Deterministic</span><span class="p">(</span><span class="s">'beta_male_edu'</span><span class="p">,</span> <span class="n">alpha_male_edu</span><span class="o">+</span><span class="n">beta_male_edu_std</span><span class="o">*</span><span class="n">sigma_male_edu</span><span class="p">)</span>
    <span class="n">gamma_centro</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'gamma_centro'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">gamma_mezzogiorno</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Normal</span><span class="p">(</span><span class="s">'gamma_mezzogiorno'</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta_group</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span> <span class="o">+</span> <span class="n">beta_male</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_degree</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span> <span class="o">+</span> <span class="n">gamma_centro</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span><span class="o">+</span> <span class="n">gamma_mezzogiorno</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span>
         <span class="o">+</span> <span class="n">beta_male_edu</span><span class="p">[</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span><span class="o">*</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="s">'y'</span><span class="p">,</span> <span class="n">logit_p</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">df_fit</span><span class="p">[</span><span class="s">'y'</span><span class="p">])</span>

<span class="n">pm</span><span class="p">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/model.webp" alt="" /></p>

<p>As you can see, we slightly modified our parametrization to improve the convergence.
We are now ready to sample the posterior.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">idata</span> <span class="o">=</span> <span class="n">pm</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">nuts_sampler</span><span class="o">=</span><span class="s">'numpyro'</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">draws</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                      <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">target_accept</span><span class="o">=</span><span class="mf">0.85</span><span class="p">)</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">idata</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/trace.webp" alt="" /></p>

<p>The traces look fine, but since this is quite a messy model, it is better to also inspect
the $\hat{R}$ statistics</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">az</span><span class="p">.</span><span class="n">summary</span><span class="p">(</span><span class="n">idata</span><span class="p">)[</span><span class="s">'r_hat'</span><span class="p">].</span><span class="nb">max</span><span class="p">()</span>
</code></pre></div></div>

<div class="code">
1.0
</div>

<p>$\hat{R}$ is fine too, so we can assume that there are no issues with our model.
Let us take a look at the separation plot</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">model</span><span class="p">:</span>
    <span class="n">idata</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">rng</span><span class="p">))</span>

<span class="n">az</span><span class="p">.</span><span class="n">plot_separation</span><span class="p">(</span><span class="n">idata</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/separation.webp" alt="" /></p>

<p>The result is far from being perfect, but the darker blue lines are mostly
on the right hand side, so the model is doing quite a decent job.
We can now verify the results of our model.
Let us implement two routines to perform the model predictions,
with and without post-stratification:</p>

\[\begin{align*}
\theta_{PS} = &amp; \frac{\sum_i N_i \theta_i}{\sum_i N_i} \\
\theta_{Raw} = &amp; \frac{\sum_i  N_i^{sample} \theta_i}{\sum_i N_i^{sample}}
\end{align*}\]

<p>where $N_i$ is the number of individuals in the group i (or equivalently the percentage),
and $\theta_i$ the corresponding estimate.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">fcalc</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">idata</span><span class="p">.</span><span class="n">posterior</span>
    <span class="n">logit_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s">'alpha'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_group'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_group_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_male'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_degree'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_degree_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'beta_male_edu'</span><span class="p">].</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_male_edu_dim_0</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]).</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'is_male'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'gamma_mezzogiorno'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'Mezzogiorno'</span><span class="p">]</span>
               <span class="o">+</span> <span class="n">dt</span><span class="p">[</span><span class="s">'gamma_centro'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">df</span><span class="p">[</span><span class="s">'Centro'</span><span class="p">]</span>
              <span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logit_p</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logit_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">get_proba</span><span class="p">(</span><span class="n">df_filt</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'frac'</span><span class="p">):</span>
    <span class="n">out_mean</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_ql</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">out_qh</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">df_filt</span><span class="p">[</span><span class="n">col</span><span class="p">].</span><span class="nb">sum</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_filt</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">dt</span> <span class="o">+=</span> <span class="n">fcalc</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">/</span><span class="n">norm</span>
    <span class="n">out_mean</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">out_ql</span>  <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">out_qh</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">out_mean</span><span class="p">,</span> <span class="n">out_ql</span><span class="p">,</span> <span class="n">out_qh</span><span class="p">]</span>
</code></pre></div></div>

<p>We can now compare the results of the post-stratification with the corresponding
raw estimate</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nat_proba</span> <span class="o">=</span> <span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">)</span>

<span class="n">grp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">'N'</span><span class="p">,</span> <span class="s">'C'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">]):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
    
    <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[((</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">)</span> <span class="p">)])</span>
           <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
    <span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'PS'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>

    <span class="n">prob1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">[((</span><span class="n">df_n_by_group</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">))],</span> <span class="n">col</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
    <span class="n">asymmetric_error1</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">prob1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'Raw'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Region=</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'&lt;30'</span><span class="p">,</span> <span class="s">'30-39'</span><span class="p">,</span> <span class="s">'40-49'</span><span class="p">,</span> <span class="s">'50-59'</span><span class="p">,</span> <span class="s">'60+'</span><span class="p">])</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

</code></pre></div></div>
<p><img src="/docs/assets/images/statistics/mrp/PS_compare.webp" alt="" /></p>

<p>We recall that the percentages of people with a degree in our sample is very different
from the one in the Italian population, and this implies that there are
large differences between the post-stratified estimates and the raw estimates.</p>

<p>We can now inspect the effect of the education for each region and age group.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grp_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s">'N'</span><span class="p">,</span> <span class="s">'C'</span><span class="p">,</span> <span class="s">'M'</span><span class="p">]):</span>
    <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'--'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">':'</span><span class="p">)</span>
        
        <span class="n">prob</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_proba</span><span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[((</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Regione'</span><span class="p">]</span><span class="o">==</span><span class="n">region</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'has_degree'</span><span class="p">]</span><span class="o">==</span><span class="n">deg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_anag_deg</span><span class="p">[</span><span class="s">'Gruppo'</span><span class="p">]</span> <span class="o">==</span> <span class="n">grp</span><span class="p">))])</span>
               <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">grp_list</span><span class="p">]).</span><span class="n">T</span>
        <span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">])))).</span><span class="n">T</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">deg</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">grp_list</span><span class="p">)</span><span class="o">+</span><span class="mf">0.05</span><span class="o">*</span><span class="n">deg</span><span class="p">,</span> <span class="n">prob</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s">'Has degree=</span><span class="si">{</span><span class="nb">bool</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span><span class="si">}</span><span class="s">'</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>


    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s">"Region=</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    
    <span class="n">legend</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.94</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">))</span>
    <span class="n">legend</span><span class="p">.</span><span class="n">get_frame</span><span class="p">().</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'&lt;30'</span><span class="p">,</span> <span class="s">'30-39'</span><span class="p">,</span> <span class="s">'40-49'</span><span class="p">,</span> <span class="s">'50-59'</span><span class="p">,</span> <span class="s">'60+'</span><span class="p">])</span>
<span class="n">fig</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/estimates.webp" alt="" /></p>

<p>We can finally provide a national-level estimate for the target probability</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">nat_proba_raw</span> <span class="o">=</span> <span class="n">get_proba</span><span class="p">(</span><span class="n">df_n_by_group</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s">'y'</span><span class="p">)</span>

<span class="n">dt_mean</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">dt_low</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">dt_high</span> <span class="o">=</span> <span class="p">[</span><span class="n">nat_proba</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nat_proba_raw</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

<span class="n">asymmetric_error</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_low</span><span class="p">),</span>
                                     <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_high</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)))).</span><span class="n">T</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)),</span> <span class="n">dt_mean</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">asymmetric_error</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">'None'</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_mean</span><span class="p">)))</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">'Post-stratified'</span><span class="p">,</span> <span class="s">'Raw estimate'</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">ax</span><span class="p">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">])</span>
</code></pre></div></div>

<p><img src="/docs/assets/images/statistics/mrp/national_estimate.webp" alt="" /></p>

<p>The mean difference between the stratified estimate and the raw one
is of the order of the 10%,
and it’s of the same order of magnitude of the 90% CI,
therefore the raw estimate is totally unreliable.</p>

<h2 id="conclusions">Conclusions</h2>

<p>We discussed MRP, and we have seen how to implement it in Python in order to provide
reliable estimates for surveys, especially when they are performed on a selected population.</p>

<h2 id="suggested-readings">Suggested readings</h2>

<ul>
  <li><a href="https://bookdown.org/jl5522/MRP-case-studies/">“MRP case studies” and references therein, by Juan Lopez-Martin, Justin H. Phillips, and Andrew Gelman</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">load_ext</span> <span class="n">watermark</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">watermark</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">u</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">iv</span> <span class="o">-</span><span class="n">w</span> <span class="o">-</span><span class="n">p</span> <span class="n">xarray</span><span class="p">,</span><span class="n">numpyro</span><span class="p">,</span><span class="n">jax</span><span class="p">,</span><span class="n">jaxlib</span>
</code></pre></div></div>
<div class="code">
Last updated: Wed Aug 28 2024
<br />

<br />
Python implementation: CPython
<br />
Python version       : 3.12.4
<br />
IPython version      : 8.24.0
<br />

<br />
xarray : 2024.5.0
<br />
numpyro: 0.15.0
<br />
jax    : 0.4.28
<br />
jaxlib : 0.4.28
<br />

<br />
numpy     : 1.26.4
<br />
pymc      : 5.16.2
<br />
pandas    : 2.2.2
<br />
seaborn   : 0.13.2
<br />
matplotlib: 3.9.0
<br />
arviz     : 0.18.0
<br />

<br />
Watermark: 2.4.3
<br />
</div>
